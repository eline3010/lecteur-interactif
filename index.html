<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur Interactif - Analyse de Pr√©cision</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .text-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .text-to-read {
            font-size: 20px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 20px;
        }

        .text-to-read .word {
            display: inline;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .text-to-read .word.current {
            background: #fff3cd;
            font-weight: 600;
        }

        .text-to-read .word.correct {
            background: #d4edda;
        }

        .text-to-read .word.incorrect {
            background: #f8d7da;
        }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-btn.active {
            background: #667eea;
            color: white;
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            margin: 20px 0;
        }

        .recording-indicator.active {
            display: flex;
        }

        .pulse {
            width: 20px;
            height: 20px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .results-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .results-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .metric-value {
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .history-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .history-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .feedback {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .feedback-positive {
            border-left: 4px solid #28a745;
        }

        .feedback-warning {
            border-left: 4px solid #ffc107;
        }

        .tips {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tips h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .tips ul {
            margin-left: 20px;
        }

        .tips li {
            margin-bottom: 5px;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .control-buttons {
                flex-direction: column;
            }
            
            .difficulty-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Lecteur Interactif</h1>
            <p>Analyse de la pr√©cision en lecture - Identifie les mots difficiles</p>
        </div>

        <div class="content">
            <!-- Banni√®re d'avertissement pour les permissions -->
            <div id="permissionBanner" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
                <h3 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Permissions requises</h3>
                <p style="color: #856404; margin-bottom: 15px;">
                    Cette application a besoin d'acc√©der √† ton microphone pour fonctionner.
                </p>
                <p style="color: #856404; margin-bottom: 15px;">
                    <strong>Important :</strong> Quand tu cliques sur "Tester mon microphone" ou "Commencer la lecture", 
                    ton navigateur va afficher une petite fen√™tre en haut de la page te demandant d'autoriser l'acc√®s au microphone.
                </p>
                <p style="color: #856404; margin-bottom: 15px;">
                    üëâ <strong>Tu DOIS cliquer sur "Autoriser" ou "Allow"</strong> pour que l'application puisse t'√©couter lire.
                </p>
                <button onclick="document.getElementById('permissionBanner').style.display='none'" 
                        style="background: #ffc107; color: #333; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    J'ai compris
                </button>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('lecture')">üìñ Lecture</button>
                <button class="tab-btn" onclick="switchTab('resultats')">üìä R√©sultats</button>
                <button class="tab-btn" onclick="switchTab('progres')">üìà Progr√®s</button>
            </div>

            <!-- Onglet Lecture -->
            <div id="lecture-tab" class="tab-content active">
                <div class="text-card">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Choisis le niveau de difficult√© :</h3>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn active" onclick="selectDifficulty('facile')">‚≠ê Facile (CP-CE1)</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('moyen')">‚≠ê‚≠ê Moyen (CE2)</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('difficile')">‚≠ê‚≠ê‚≠ê Difficile (CM1-CM2)</button>
                    </div>
                </div>

                <div class="text-card">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Texte √† lire :</h3>
                    <div class="text-to-read" id="textToRead"></div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üí° Avant de commencer :</h4>
                        <ul style="margin-left: 20px; color: #856404;">
                            <li>Assure-toi d'√™tre dans un endroit calme</li>
                            <li>Parle clairement et pas trop vite</li>
                            <li>Tiens-toi pr√®s du microphone</li>
                            <li>Autorise l'acc√®s au micro quand ton navigateur te le demande</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="testMicrophone()" style="margin-top: 10px; font-size: 14px; padding: 10px 15px;">
                            üé§ Tester mon microphone
                        </button>
                    </div>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <div class="pulse"></div>
                    <span style="font-weight: 600;">üé§ Enregistrement en cours... Lis le texte √† voix haute</span>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" id="startBtn" onclick="startReading()">
                        üé§ Commencer la lecture
                    </button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopReading()" disabled>
                        ‚èπÔ∏è Terminer
                    </button>
                    <button class="btn btn-secondary" onclick="loadNewText()">
                        üîÑ Nouveau texte
                    </button>
                </div>

                <div class="results-card" id="currentResults" style="display: none;">
                    <h3>üìä R√©sultats de cette lecture</h3>
                    <div id="sessionResults"></div>
                </div>
            </div>

            <!-- Onglet R√©sultats -->
            <div id="resultats-tab" class="tab-content">
                <div class="stats-grid" id="overallStats"></div>
                <div id="lastSessionDetails"></div>
            </div>

            <!-- Onglet Progr√®s -->
            <div id="progres-tab" class="tab-content">
                <div class="chart-container">
                    <h3>üìä √âvolution sur les Textes d'√âvaluation</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Ces textes de r√©f√©rence sont relus r√©guli√®rement pour mesurer objectivement tes progr√®s
                    </p>
                    <canvas id="evaluationChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üìà Moyenne G√©n√©rale de Pr√©cision</h3>
                    <canvas id="progressChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>üìä R√©partition des Types de Textes</h3>
                    <canvas id="textTypeChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üéØ Textes √† Retravailler</h3>
                    <div id="difficultTextsList"></div>
                </div>

                <div class="chart-container">
                    <h3>üìú Historique des S√©ances</h3>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Textes de lecture par niveau - biblioth√®que enrichie
        const texts = {
            facile: [
                // Phrases simples sur la vie quotidienne (20)
                "Le chat est sur le tapis. Il dort au soleil. Il est tout doux.",
                "Papa lit un livre. Maman fait un g√¢teau. Je joue avec mon ballon.",
                "Dans le jardin, il y a des fleurs. Les fleurs sont jolies. J'aime les roses rouges.",
                "Mon ami s'appelle Tom. Il a un v√©lo bleu. Nous allons au parc ensemble.",
                "Le soleil brille dans le ciel. Les oiseaux chantent. C'est une belle journ√©e.",
                "J'ai un chien qui s'appelle Max. Il aime courir dans le jardin. Je joue avec lui tous les jours.",
                "Ma s≈ìur dessine une maison. Elle met des fen√™tres et une porte. C'est tr√®s joli.",
                "Il y a un arbre dans la cour. Les enfants jouent sous l'arbre. Ils rient beaucoup.",
                "Le chat boit du lait. Il mange des croquettes. Puis il se lave les pattes.",
                "J'aime les pommes rouges. Je mange une pomme √† la r√©cr√©. C'est bon et sucr√©.",
                "La pluie tombe sur le toit. J'entends les gouttes d'eau. Je reste au chaud √† la maison.",
                "Mon cartable est lourd. Il y a des livres dedans. Je le porte sur mon dos.",
                "Le poisson nage dans l'eau. Il fait des bulles. Il est orange et blanc.",
                "Ma maman fait du pain. √áa sent tr√®s bon dans la cuisine. J'ai tr√®s faim.",
                "Le petit oiseau vole dans le ciel. Il cherche des graines. Il se pose sur une branche.",
                "J'ai une poup√©e qui s'appelle Lisa. Elle a une robe rose. Je l'aime beaucoup.",
                "Le bus arrive √† l'√©cole. Les enfants montent dedans. Le chauffeur dit bonjour.",
                "Mon papa joue au ballon avec moi. Il lance le ballon tr√®s haut. Je cours pour l'attraper.",
                "Il fait froid dehors. Je mets mon manteau et mon √©charpe. Mes mains sont bien au chaud.",
                "La ma√Ætresse lit une histoire. Tous les enfants √©coutent. C'est l'histoire d'un lion.",
                
                // Phrases sur les animaux (15)
                "Le lapin mange des carottes. Il a de grandes oreilles. Il saute dans l'herbe.",
                "La vache fait meuh. Elle donne du lait. Elle vit dans un pr√©.",
                "Le coq chante le matin. Cocorico ! Il r√©veille toute la ferme.",
                "La souris est petite. Elle court tr√®s vite. Elle a une longue queue.",
                "Le canard nage sur l'√©tang. Il a des plumes jaunes. Il fait coin-coin.",
                "L'abeille fait du miel. Elle vole de fleur en fleur. Elle vit dans une ruche.",
                "Le cheval galope dans le champ. Il est grand et fort. J'aime le regarder courir.",
                "La poule pond des ≈ìufs. Elle les garde au chaud. Les poussins vont na√Ætre.",
                "Le papillon a des ailes color√©es. Il vole l√©ger dans l'air. Il se pose sur une fleur.",
                "L'escargot avance lentement. Il porte sa maison sur son dos. Il laisse une trace.",
                "Le mouton a de la laine. Il vit avec les autres moutons. Le berger s'occupe de lui.",
                "La coccinelle est rouge avec des points noirs. Elle grimpe sur ma main. Elle s'envole.",
                "Le h√©risson a des piquants. Il se roule en boule. Il dort l'hiver.",
                "La tortue marche doucement. Elle a une carapace dure. Elle vit tr√®s longtemps.",
                "Le cochon est rose. Il aime se rouler dans la boue. Il grogne fort.",
                
                // Phrases sur les saisons et la nature (15)
                "En automne, les feuilles tombent. Elles sont jaunes et rouges. J'aime marcher dessus.",
                "En hiver, il neige. Les flocons sont blancs. Je fais un bonhomme de neige.",
                "Au printemps, les fleurs poussent. Les arbres ont des bourgeons. Tout redevient vert.",
                "En √©t√©, il fait chaud. Je vais √† la plage. Je me baigne dans la mer.",
                "Le vent souffle fort. Les branches bougent. Mon chapeau s'envole.",
                "L'arc-en-ciel a sept couleurs. Il appara√Æt apr√®s la pluie. C'est magique.",
                "Les nuages sont dans le ciel. Ils sont blancs et gris. Parfois ils cachent le soleil.",
                "La lune brille la nuit. Les √©toiles scintillent. C'est joli dans le noir.",
                "La rivi√®re coule doucement. L'eau est fra√Æche. Des petits poissons nagent dedans.",
                "La montagne est tr√®s haute. Il y a de la neige au sommet. C'est beau √† regarder.",
                "Le jardin est fleuri. Il y a des tulipes et des marguerites. √áa sent bon.",
                "L'herbe est verte et douce. Je m'allonge dessus. Je regarde les nuages.",
                "Les champignons poussent en for√™t. Certains sont rouges. Il ne faut pas les manger.",
                "Le soleil se l√®ve le matin. Il se couche le soir. La journ√©e commence et se termine.",
                "L'orage gronde. On entend le tonnerre. Je vois les √©clairs dans le ciel."
            ],
            
            moyen: [
                // R√©cits du quotidien (15)
                "L√©a adore les animaux. Chaque mercredi, elle va √† la ferme avec son grand-p√®re. Elle donne √† manger aux poules et aux lapins. C'est son moment pr√©f√©r√© de la semaine.",
                "Dans la for√™t, les arbres sont tr√®s hauts. Les √©cureuils sautent de branche en branche. Parfois, on peut voir des biches qui se prom√®nent tranquillement.",
                "Pierre collectionne les cailloux. Il a trouv√© un cristal brillant pr√®s de la rivi√®re. C'est son plus beau tr√©sor. Il le montre fi√®rement √† tous ses amis.",
                "La biblioth√®que du quartier est immense. Marie y va tous les samedis. Elle emprunte des livres d'aventures et de sciences. La biblioth√©caire est tr√®s gentille.",
                "Pendant les vacances, nous sommes all√©s √† la mer. J'ai construit un ch√¢teau de sable √©norme. Les vagues venaient doucement le mouiller. C'√©tait magnifique.",
                "Ce matin, j'ai rat√© le bus scolaire. J'ai d√ª courir jusqu'√† l'arr√™t suivant. Heureusement, le chauffeur m'a attendu. J'√©tais essouffl√© mais content.",
                "Ma grand-m√®re pr√©pare les meilleures cr√™pes du monde. Elle les fait sauter dans la po√™le. J'adore les regarder tourner dans les airs avant de retomber.",
                "Le nouveau voisin a un perroquet vert. L'oiseau r√©p√®te tout ce qu'on lui dit. Hier, il a appris √† dire mon pr√©nom. C'√©tait tr√®s dr√¥le.",
                "Au march√©, il y a plein de couleurs et d'odeurs. Le marchand de fruits crie pour vendre ses oranges. Ma m√®re ach√®te toujours des fraises quand c'est la saison.",
                "Mon petit fr√®re a perdu sa premi√®re dent. Il l'a mise sous son oreiller. Le lendemain matin, il a trouv√© une pi√®ce. Il √©tait fou de joie.",
                "La classe est partie en sortie au mus√©e. Nous avons vu des tableaux tr√®s anciens. La guide nous a racont√© l'histoire de chaque peintre. C'√©tait passionnant.",
                "Papa a install√© une cabane dans le jardin. Mes amis et moi, on y joue aux explorateurs. On imagine qu'on est sur une √Æle d√©serte.",
                "Tous les dimanches, je vais chez ma tante. Elle habite une petite maison √† la campagne. On se prom√®ne dans les champs et on cueille des m√ªres.",
                "Le chat du voisin vient souvent dormir sur notre terrasse. Il se met au soleil et ronronne doucement. Parfois, je le caresse et il se frotte contre ma jambe.",
                "Hier soir, j'ai regard√© un film d'animation avec ma famille. C'√©tait l'histoire d'un robot qui voulait devenir humain. √Ä la fin, tout le monde a pleur√©.",
                
                // Descriptions et r√©cits imaginaires (20)
                "Le dragon vivait au sommet d'une montagne. Il gardait un tr√©sor pr√©cieux dans sa grotte. Personne n'osait s'approcher car il crachait du feu. Mais il √©tait moins m√©chant qu'on le pensait.",
                "La princesse habitait dans un ch√¢teau entour√© de douves. Elle passait ses journ√©es √† lire dans la biblioth√®que. Un jour, elle d√©cida de partir √† l'aventure d√©guis√©e en paysanne.",
                "Le magicien avait une longue barbe blanche et un chapeau pointu. Il pr√©parait des potions dans son laboratoire secret. Ses sorts ne fonctionnaient pas toujours comme pr√©vu.",
                "Au fond de l'oc√©an vivait une sir√®ne curieuse. Elle collectionnait des objets venus de la surface. Son r√™ve √©tait de marcher sur la terre ferme.",
                "Le petit robot ne savait pas pleurer ni rire. Il observait les humains avec curiosit√©. Il voulait comprendre ce que c'√©tait que d'avoir des √©motions.",
                "Dans la for√™t enchant√©e, les arbres parlaient entre eux. Les f√©es dansaient autour des champignons g√©ants. Les animaux comprenaient le langage des humains.",
                "Le vieux sage habitait au sommet de la colline. Les gens venaient de loin pour lui demander conseil. Il r√©pondait toujours par des √©nigmes.",
                "L'apprenti cuisinier r√™vait de devenir le meilleur chef du royaume. Il s'entra√Ænait tous les jours √† pr√©parer de nouvelles recettes. Son plat pr√©f√©r√© √©tait la tarte aux pommes.",
                "Le petit renard rus√© voulait voler les poules du fermier. Mais le chien de garde √©tait malin et veillait. Chaque nuit, c'√©tait un nouveau stratag√®me.",
                "La sorci√®re n'√©tait pas m√©chante contrairement √† ce que tout le monde croyait. Elle soignait les animaux malades et cultivait des plantes magiques dans son jardin secret.",
                "Le pirate avait cach√© son tr√©sor sur une √Æle d√©serte. Il avait dessin√© une carte avec des indices myst√©rieux. Mais il avait oubli√© o√π il l'avait cach√©e.",
                "L'astronaute explorait une plan√®te inconnue. Le sol √©tait violet et le ciel orange. Des cr√©atures √©tranges le regardaient avec curiosit√© depuis les rochers.",
                "Le d√©tective cherchait des indices pour r√©soudre l'√©nigme. Qui avait vol√© les biscuits dans la cuisine ? Tous les indices menaient au chat de la maison.",
                "La f√©e des dents travaillait toute la nuit. Elle devait r√©cup√©rer les dents sous les oreillers et laisser des pi√®ces. C'√©tait un travail fatigant mais important.",
                "Le fant√¥me du ch√¢teau √©tait timide. Il ne voulait pas faire peur aux visiteurs. Il se cachait dans les coins sombres et faisait de petits bruits discrets.",
                "Le g√©ant √©tait si grand qu'il touchait les nuages. Pourtant, il √©tait tr√®s doux et adorait les petites cr√©atures. Il aidait les oiseaux √† construire leurs nids.",
                "La musicienne jouait du violon sur la place du village. Les gens s'arr√™taient pour l'√©couter. Sa musique √©tait si belle qu'elle faisait danser les oiseaux.",
                "Le jardinier connaissait tous les secrets des plantes. Il leur parlait chaque matin et elles poussaient magnifiquement. Son jardin √©tait le plus beau de la r√©gion.",
                "L'inventeur cr√©ait des machines extraordinaires dans son atelier. Son dernier projet √©tait une bicyclette qui pouvait voler. Il ne lui manquait plus que les ailes.",
                "Le photographe parcourait le monde pour capturer des images rares. Il avait d√©j√† visit√© cinquante pays. Son appareil photo √©tait son meilleur ami.",
                
                // Petites le√ßons de vie et morales (15)
                "Mon ami Lucas m'a aid√© √† r√©viser mes le√ßons. Gr√¢ce √† lui, j'ai eu une bonne note au contr√¥le. C'est important d'aider les autres quand ils en ont besoin.",
                "J'ai trouv√© un portefeuille par terre. Il y avait de l'argent dedans. Je l'ai rapport√© au bureau des objets trouv√©s. La dame √©tait tr√®s contente.",
                "Ma petite s≈ìur pleurait parce qu'elle avait perdu son doudou. Toute la famille l'a cherch√©. On l'a retrouv√© sous le canap√©. Elle √©tait tellement heureuse.",
                "J'avais peur de plonger du grand plongeoir. Mon entra√Æneur m'a encourag√©. J'ai pris mon courage √† deux mains et j'ai saut√©. J'√©tais fier de moi.",
                "Le nouveau √©l√®ve √©tait tout seul dans la cour. Je suis all√© lui parler et je l'ai pr√©sent√© √† mes amis. Maintenant, on joue ensemble tous les jours.",
                "J'ai cass√© le vase pr√©f√©r√© de maman en jouant au ballon. J'avais peur de lui dire. Mais j'ai avou√© la v√©rit√©. Elle n'√©tait pas contente mais elle m'a pardonn√©.",
                "Mon chien √©tait malade et le v√©t√©rinaire a dit qu'il fallait le soigner. J'ai √©conomis√© mon argent de poche pour payer les m√©dicaments. Maintenant, il va beaucoup mieux.",
                "J'ai vu un enfant se faire emb√™ter par des plus grands. Je suis all√© chercher un adulte pour l'aider. Ce n'est pas bien de rester sans rien faire.",
                "Ma mamie m'a appris √† tricoter. Au d√©but, c'√©tait difficile et je voulais abandonner. Mais j'ai continu√© √† m'entra√Æner. Maintenant, je sais faire une √©charpe.",
                "J'ai perdu la finale du tournoi de tennis. J'√©tais tr√®s d√©√ßu. Mon papa m'a dit que l'important c'est de faire de son mieux. J'ai compris qu'on ne peut pas toujours gagner.",
                "Mon voisin √¢g√© portait des sacs lourds. Je lui ai propos√© de l'aider. Il m'a remerci√© avec un grand sourire. √áa fait du bien d'aider les personnes √¢g√©es.",
                "J'ai menti √† la ma√Ætresse sur mes devoirs. Toute la journ√©e, je me suis senti mal. Le soir, j'ai avou√© la v√©rit√©. Elle m'a puni mais j'√©tais soulag√©.",
                "Ma meilleure amie a d√©m√©nag√© dans une autre ville. Au d√©but, j'√©tais triste. Mais on s'√©crit des lettres et on se t√©l√©phone. L'amiti√© reste m√™me √† distance.",
                "J'ai voulu apprendre √† faire du v√©lo sans petites roues. Je suis tomb√© plusieurs fois. Mais je me suis relev√© √† chaque fois. Maintenant, je roule sans probl√®me.",
                "Mon fr√®re et moi, on se dispute souvent pour des b√™tises. Mais quand l'un de nous a un probl√®me, l'autre est toujours l√† pour aider. C'est √ßa, la famille."
            ],
            
            difficile: [
                // Sciences et d√©couvertes (15)
                "L'exploration spatiale fascine les scientifiques depuis des d√©cennies. Les astronautes s'entra√Ænent pendant des ann√©es avant de partir en mission. Ils doivent apprendre √† vivre en apesanteur et √† r√©soudre des probl√®mes complexes dans des situations d'urgence.",
                "Les volcans sont des montagnes particuli√®res qui peuvent entrer en √©ruption. Le magma, cette roche en fusion venue des profondeurs de la Terre, remonte √† la surface. Quand il jaillit, on l'appelle de la lave. Les √©ruptions volcaniques peuvent √™tre spectaculaires mais aussi dangereuses.",
                "La photosynth√®se est un ph√©nom√®ne extraordinaire. Gr√¢ce √† la lumi√®re du soleil, les plantes transforment le dioxyde de carbone en oxyg√®ne. Ce processus est essentiel √† la vie sur Terre car il permet de purifier l'air que nous respirons.",
                "Les migrations des oiseaux restent myst√©rieuses. Chaque ann√©e, certaines esp√®ces parcourent des milliers de kilom√®tres. Elles traversent des oc√©ans et des continents pour retrouver des climats plus cl√©ments. Leur sens de l'orientation est remarquable.",
                "Le cycle de l'eau est un processus naturel fascinant. L'eau s'√©vapore des oc√©ans, forme des nuages, puis retombe en pluie. Cette eau rejoint ensuite les rivi√®res qui retournent √† la mer. Ce cycle se r√©p√®te ind√©finiment.",
                "Les dinosaures ont domin√© la Terre pendant plus de cent soixante millions d'ann√©es. Certains √©taient herbivores et se nourrissaient de plantes. D'autres √©taient de redoutables pr√©dateurs. Ils ont myst√©rieusement disparu il y a soixante-cinq millions d'ann√©es.",
                "Le corps humain est une machine extraordinaire. Le c≈ìur bat environ cent mille fois par jour. Les poumons permettent de respirer et d'apporter l'oxyg√®ne au sang. Le cerveau contr√¥le toutes les fonctions du corps.",
                "Les abeilles jouent un r√¥le crucial dans la nature. En butinant les fleurs, elles transportent le pollen d'une plante √† l'autre. Ce processus, appel√© pollinisation, permet aux plantes de se reproduire. Sans les abeilles, de nombreuses esp√®ces v√©g√©tales dispara√Ætraient.",
                "La Terre tourne sur elle-m√™me en vingt-quatre heures. C'est ce qui cr√©e le jour et la nuit. Elle tourne √©galement autour du Soleil en trois cent soixante-cinq jours. Cette r√©volution d√©termine les saisons.",
                "Les fossiles sont les restes d'organismes vivants conserv√©s dans les roches. Ils permettent aux scientifiques d'√©tudier les esp√®ces disparues. Certains fossiles ont plusieurs millions d'ann√©es. Ils racontent l'histoire de la vie sur Terre.",
                "L'√©lectricit√© est une forme d'√©nergie que nous utilisons quotidiennement. Elle est produite dans des centrales puis transport√©e par des c√¢bles. Elle alimente nos maisons, nos √©coles et nos appareils √©lectroniques.",
                "Les oc√©ans couvrent plus de soixante-dix pour cent de la surface de notre plan√®te. Ils abritent une biodiversit√© incroyable. Des milliers d'esp√®ces y vivent, des plus petites aux plus grandes. Les oc√©ans r√©gulent √©galement le climat mondial.",
                "Le syst√®me solaire est compos√© du Soleil et de huit plan√®tes. Mercure est la plus proche du Soleil. Neptune est la plus √©loign√©e. La Terre est la seule plan√®te o√π l'on a trouv√© de la vie.",
                "Les fourmis vivent en colonies organis√©es comme de v√©ritables soci√©t√©s. Chaque fourmi a un r√¥le pr√©cis : reine, ouvri√®re ou soldat. Elles communiquent entre elles gr√¢ce √† des substances chimiques. Leur force collective est impressionnante.",
                "L'ADN contient toutes les informations g√©n√©tiques d'un √™tre vivant. C'est comme un livre d'instructions qui d√©termine nos caract√©ristiques. Chaque personne poss√®de un ADN unique, sauf les vrais jumeaux qui partagent le m√™me.",
                
                // Histoire et patrimoine (15)
                "Au Moyen √Çge, les ch√¢teaux forts prot√©geaient les seigneurs et leurs familles. Ces imposantes forteresses √©taient entour√©es de douves remplies d'eau. Des pont-levis permettaient d'entrer et de sortir. Les soldats surveillaient les environs depuis les hautes tours.",
                "Les pyramides d'√âgypte ont √©t√© construites il y a plus de quatre mille ans. Elles servaient de tombeaux aux pharaons. Des milliers d'ouvriers ont travaill√© pendant des ann√©es pour les √©riger. Aujourd'hui encore, on s'interroge sur les techniques utilis√©es.",
                "Pendant la Renaissance, les artistes italiens ont r√©volutionn√© l'art europ√©en. L√©onard de Vinci √©tait √† la fois peintre, inventeur et scientifique. Michel-Ange a peint le plafond de la chapelle Sixtine. Cette p√©riode a marqu√© un tournant dans l'histoire culturelle.",
                "Les Vikings √©taient de redoutables navigateurs scandinaves. Ils parcouraient les mers sur leurs drakkars. Ils ont d√©couvert l'Islande et le Groenland. Certains auraient m√™me atteint l'Am√©rique bien avant Christophe Colomb.",
                "La R√©volution fran√ßaise a profond√©ment transform√© la soci√©t√©. Le peuple s'est soulev√© contre la monarchie. La D√©claration des droits de l'homme a √©t√© adopt√©e. Ces √©v√©nements ont influenc√© le monde entier.",
                "Les Romains ont construit un immense empire autour de la M√©diterran√©e. Ils ont d√©velopp√© des techniques de construction avanc√©es. Leurs aqueducs transportaient l'eau sur de longues distances. Beaucoup de leurs r√©alisations sont encore visibles aujourd'hui.",
                "L'invention de l'imprimerie par Gutenberg a r√©volutionn√© la diffusion du savoir. Avant cette invention, les livres √©taient copi√©s √† la main. Gr√¢ce √† l'imprimerie, les connaissances sont devenues accessibles √† un plus grand nombre.",
                "Les grandes explorations du quinzi√®me si√®cle ont chang√© la carte du monde. Les navigateurs cherchaient de nouvelles routes commerciales. Ils ont d√©couvert des continents inconnus des Europ√©ens. Ces voyages ont favoris√© les √©changes entre les civilisations.",
                "La Pr√©histoire d√©signe la p√©riode avant l'invention de l'√©criture. Les hommes pr√©historiques vivaient de la chasse et de la cueillette. Ils ont invent√© le feu et fabriqu√© des outils. Ils ont laiss√© des peintures magnifiques dans les grottes.",
                "Les ch√¢teaux de la Loire ont √©t√© construits √† la Renaissance. Ils servaient de r√©sidences royales. Leur architecture m√™le √©l√©gance et raffinement. Ils attirent aujourd'hui des millions de visiteurs du monde entier.",
                "L'Antiquit√© grecque a vu na√Ætre la d√©mocratie √† Ath√®nes. Les citoyens participaient aux d√©cisions politiques. Les Grecs ont √©galement excell√© dans les arts, la philosophie et les sciences. Leur h√©ritage influence encore notre soci√©t√© moderne.",
                "Les Gaulois occupaient le territoire de la France actuelle avant la conqu√™te romaine. Ils vivaient dans des villages fortifi√©s appel√©s oppidums. Jules C√©sar les a conquis apr√®s de longues guerres. Vercing√©torix fut leur chef le plus c√©l√®bre.",
                "La guerre de Cent Ans a oppos√© la France et l'Angleterre pendant plus d'un si√®cle. Jeanne d'Arc, une jeune paysanne, a jou√© un r√¥le crucial. Elle a men√© les arm√©es fran√ßaises √† plusieurs victoires. Son courage est rest√© dans les m√©moires.",
                "Les chevaliers suivaient un code d'honneur strict appel√© la chevalerie. Ils devaient prot√©ger les faibles et servir leur seigneur. Ils participaient √† des tournois pour prouver leur bravoure. Leur armure pesait plusieurs dizaines de kilos.",
                "L'invention de la roue a √©t√© une r√©volution majeure. Elle a facilit√© le transport des marchandises. Les chars et les chariots sont devenus possibles. Cette invention remonte √† plus de cinq mille ans.",
                
                // R√©cits d'aventure et imagination (20)
                "L'explorateur avan√ßait prudemment dans la jungle dense. Des lianes pendaient des arbres centenaires. Il cherchait les ruines d'une cit√© perdue depuis des si√®cles. Soudain, il aper√ßut une construction de pierre envahie par la v√©g√©tation.",
                "Le vieux phare se dressait fi√®rement face aux vagues d√©cha√Æn√©es. Depuis des g√©n√©rations, il guidait les navires vers le port. Le gardien montait chaque soir allumer la lanterne. Par temps de temp√™te, sa lumi√®re √©tait l'unique espoir des marins.",
                "Dans l'atelier du luthier, une odeur de bois fra√Æchement coup√© flottait dans l'air. L'artisan fa√ßonnait avec patience chaque partie du violon. Il fallait des mois de travail minutieux. Chaque instrument √©tait une ≈ìuvre d'art unique.",
                "Le train traversait des paysages de montagnes enneig√©es. Les passagers admiraient la vue depuis les fen√™tres panoramiques. Le contr√¥leur annon√ßa l'arriv√©e imminente dans la station d'altitude. C'√©tait le d√©but d'une aventure hivernale.",
                "Au march√© aux √©pices, mille parfums se m√™laient dans l'air chaud. Les marchands vantaient leurs produits venus du monde entier. Des pyramides color√©es de safran, de curcuma et de paprika attiraient l'≈ìil. C'√©tait un festival pour les sens.",
                "L'arch√©ologue brossait d√©licatement la poterie qu'elle venait de d√©couvrir. Chaque fragment r√©v√©lait des motifs anciens. Cette trouvaille pouvait changer la compr√©hension d'une civilisation disparue. Elle documentait minutieusement chaque d√©tail.",
                "Le cirque s'installait sur la place du village. Les acrobates r√©p√©taient leurs num√©ros sous le chapiteau color√©. Les clowns pr√©paraient leurs farces. Le soir m√™me, le spectacle √©merveillerait petits et grands.",
                "Dans le laboratoire, le scientifique observait les r√©sultats de son exp√©rience. Il avait travaill√© des ann√©es sur ce projet. Les donn√©es s'affichaient sur les √©crans. Il touchait peut-√™tre au but de sa recherche.",
                "Le marathon commen√ßait dans quelques minutes. Des milliers de coureurs s'√©chauffaient sur la ligne de d√©part. Certains visaient la performance, d'autres voulaient simplement terminer. L'atmosph√®re √©tait √©lectrique.",
                "La biblioth√®que ancienne contenait des milliers d'ouvrages rares. Des escaliers en colima√ßon menaient aux √©tages sup√©rieurs. Le silence n'√©tait rompu que par le bruissement des pages. C'√©tait un temple du savoir.",
                "L'alpiniste approchait du sommet apr√®s des heures d'escalade. Le froid √©tait intense et l'oxyg√®ne se rar√©fiait. Chaque pas demandait un effort consid√©rable. Mais la vue depuis le sommet valait tous les sacrifices.",
                "Le potier faisait tourner son tour avec expertise. L'argile prenait forme sous ses mains habiles. Il cr√©ait des vases, des bols et des assiettes. Chaque pi√®ce √©tait ensuite cuite dans un four √† haute temp√©rature.",
                "Dans la serre tropicale, l'humidit√© et la chaleur √©taient oppressantes. Des plantes exotiques poussaient luxuriantes. Des papillons color√©s voletaient entre les fleurs. C'√©tait un petit coin de for√™t amazonienne en pleine ville.",
                "Le forgeron martelait le m√©tal rougi au feu. Des √©tincelles jaillissaient √† chaque coup. Il fabriquait des outils et des objets d√©coratifs. Son savoir-faire se transmettait depuis des g√©n√©rations.",
                "La danseuse r√©p√©tait inlassablement les m√™mes mouvements. Chaque geste devait √™tre parfait pour le spectacle. Des ann√©es d'entra√Ænement quotidien l'avaient men√©e jusqu'ici. Sur sc√®ne, elle semblerait danser sans effort.",
                "Le restaurateur pr√©parait avec soin chaque plat. Il s√©lectionnait les meilleurs ingr√©dients du march√©. Sa cuisine mariait tradition et cr√©ativit√©. Les clients venaient de loin pour go√ªter ses sp√©cialit√©s.",
                "Dans l'observatoire, l'astronome pointait le t√©lescope vers une galaxie lointaine. La lumi√®re des √©toiles avait voyag√© pendant des millions d'ann√©es. Chaque nuit d'observation r√©v√©lait de nouveaux myst√®res de l'univers.",
                "Le menuisier sculptait le bois avec d√©licatesse. Il cr√©ait des meubles qui dureraient des d√©cennies. Le parfum du ch√™ne et du pin embaumait l'atelier. Son travail alliait robustesse et beaut√©.",
                "La journaliste enqu√™tait sur une affaire complexe. Elle interrogeait des t√©moins et v√©rifiait chaque information. Son article devait √™tre pr√©cis et √©quilibr√©. La v√©rit√© √©tait son seul objectif.",
                "Le pilote v√©rifiait tous les instruments avant le d√©collage. La tour de contr√¥le donnait les derni√®res instructions. Les passagers attachaient leurs ceintures. L'avion allait bient√¥t s'√©lancer vers le ciel."
            ]
        };

        let currentDifficulty = 'facile';
        let currentText = '';
        let currentWords = [];
        let currentTextId = null; // ID unique du texte
        let currentTextType = 'nouveau'; // 'evaluation', 'nouveau', 'revision'
        let recognition = null;
        let isRecording = false;
        let startTime = null;
        let sessionData = {
            wordsRead: 0,
            correctWords: 0,
            totalWords: 0,
            difficulty: '',
            transcript: '',
            textId: null,
            textType: ''
        };

        // Textes de r√©f√©rence pour l'√©valuation (3 par niveau)
        const evaluationTexts = {
            facile: [0, 10, 25], // Indices des textes d'√©valuation
            moyen: [0, 15, 30],
            difficile: [0, 15, 30]
        };

        // Gestion de l'√©tat des textes
        function getTextState() {
            const state = localStorage.getItem('textState');
            if (!state) {
                return {
                    usedTexts: { facile: [], moyen: [], difficile: [] },
                    difficultTexts: { facile: [], moyen: [], difficile: [] },
                    lastEvaluationDate: null,
                    textHistory: []
                };
            }
            return JSON.parse(state);
        }

        function saveTextState(state) {
            localStorage.setItem('textState', JSON.stringify(state));
        }

        function shouldRunEvaluation() {
            const state = getTextState();
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            // √âvaluation tous les 10 textes OU si aucune √©valuation depuis 15 jours
            const lastEval = state.lastEvaluationDate ? new Date(state.lastEvaluationDate) : null;
            const daysSinceLastEval = lastEval ? Math.floor((Date.now() - lastEval.getTime()) / (1000 * 60 * 60 * 24)) : 999;
            
            const sessionsCount = history.filter(h => h.difficulty === currentDifficulty).length;
            const sessionsSinceLastEval = sessionsCount % 10;
            
            return daysSinceLastEval >= 15 || sessionsSinceLastEval === 0;
        }

        function selectText() {
            const state = getTextState();
            const textsArray = texts[currentDifficulty];
            const evalTexts = evaluationTexts[currentDifficulty];
            const usedTexts = state.usedTexts[currentDifficulty] || [];
            const difficultTexts = state.difficultTexts[currentDifficulty] || [];
            
            let selectedIndex;
            let textType;
            
            // 1. V√©rifier si c'est le moment d'une √©valuation
            if (shouldRunEvaluation()) {
                // Choisir un texte d'√©valuation al√©atoire
                selectedIndex = evalTexts[Math.floor(Math.random() * evalTexts.length)];
                textType = 'evaluation';
                state.lastEvaluationDate = new Date().toISOString();
            }
            // 2. V√©rifier s'il y a des textes difficiles √† revoir (15% de probabilit√©)
            else if (difficultTexts.length > 0 && Math.random() < 0.15) {
                // Choisir un texte difficile √† revoir
                const eligibleDifficult = difficultTexts.filter(dt => {
                    const daysSince = Math.floor((Date.now() - new Date(dt.lastAttempt).getTime()) / (1000 * 60 * 60 * 24));
                    return daysSince >= 7; // Au moins 7 jours depuis la derni√®re tentative
                });
                
                if (eligibleDifficult.length > 0) {
                    const selected = eligibleDifficult[Math.floor(Math.random() * eligibleDifficult.length)];
                    selectedIndex = selected.textId;
                    textType = 'revision';
                } else {
                    // Si aucun texte difficile √©ligible, prendre un nouveau
                    selectedIndex = selectNewText(textsArray, usedTexts, evalTexts);
                    textType = 'nouveau';
                }
            }
            // 3. Sinon, prendre un nouveau texte
            else {
                selectedIndex = selectNewText(textsArray, usedTexts, evalTexts);
                textType = 'nouveau';
            }
            
            saveTextState(state);
            return { index: selectedIndex, type: textType };
        }

        function selectNewText(textsArray, usedTexts, evalTexts) {
            // Filtrer les textes disponibles (ni utilis√©s, ni d'√©valuation)
            const availableTexts = textsArray
                .map((_, index) => index)
                .filter(i => !usedTexts.includes(i) && !evalTexts.includes(i));
            
            if (availableTexts.length === 0) {
                // Tous les textes ont √©t√© utilis√©s, r√©initialiser
                const state = getTextState();
                state.usedTexts[currentDifficulty] = [];
                saveTextState(state);
                return selectNewText(textsArray, [], evalTexts);
            }
            
            return availableTexts[Math.floor(Math.random() * availableTexts.length)];
        }

        function markTextAsUsed(textId, accuracy) {
            const state = getTextState();
            
            // Marquer comme utilis√©
            if (!state.usedTexts[currentDifficulty].includes(textId)) {
                state.usedTexts[currentDifficulty].push(textId);
            }
            
            // Si pr√©cision < 70%, ajouter aux textes difficiles
            if (accuracy < 70) {
                const existingDifficult = state.difficultTexts[currentDifficulty].find(dt => dt.textId === textId);
                if (existingDifficult) {
                    existingDifficult.attempts++;
                    existingDifficult.lastAttempt = new Date().toISOString();
                    existingDifficult.lastAccuracy = accuracy;
                } else {
                    state.difficultTexts[currentDifficulty].push({
                        textId: textId,
                        attempts: 1,
                        lastAttempt: new Date().toISOString(),
                        lastAccuracy: accuracy
                    });
                }
            } else if (accuracy >= 85) {
                // Si bien r√©ussi (‚â•85%), retirer des textes difficiles
                state.difficultTexts[currentDifficulty] = state.difficultTexts[currentDifficulty]
                    .filter(dt => dt.textId !== textId);
            }
            
            // Historique des textes
            state.textHistory.push({
                textId: textId,
                difficulty: currentDifficulty,
                date: new Date().toISOString(),
                accuracy: accuracy,
                type: currentTextType
            });
            
            // Garder seulement les 100 derniers
            if (state.textHistory.length > 100) {
                state.textHistory = state.textHistory.slice(-100);
            }
            
            saveTextState(state);
        }

        // Initialisation
        window.addEventListener('load', () => {
            loadNewText();
            loadHistory();
            updateStats();
            updateProgressCharts();
            
            // Afficher la banni√®re d'avertissement
            document.getElementById('permissionBanner').style.display = 'block';
            
            // V√©rifier la compatibilit√© de la reconnaissance vocale
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('‚ö†Ô∏è ATTENTION : Reconnaissance vocale non disponible\n\n' +
                      'Ton navigateur ne supporte pas la reconnaissance vocale.\n\n' +
                      'Pour utiliser cette application, tu dois utiliser :\n' +
                      '‚Ä¢ Chrome sur Android\n' +
                      '‚Ä¢ Safari sur iPhone/iPad\n' +
                      '‚Ä¢ Chrome ou Edge sur ordinateur\n\n' +
                      'Firefox ne supporte pas cette fonctionnalit√©.');
            }
            
            detectBrowserAndShowInstructions();
        });

        function detectBrowserAndShowInstructions() {
            const userAgent = navigator.userAgent.toLowerCase();
            let browserInfo = '';
            
            if (userAgent.includes('chrome') && !userAgent.includes('edge')) {
                browserInfo = '‚úÖ Navigateur d√©tect√© : Chrome\n\n' +
                              'Quand tu cliques sur "Tester mon microphone" :\n' +
                              '1. Une popup appara√Æt EN HAUT de la page\n' +
                              '2. Elle demande "Autoriser l\'acc√®s au microphone"\n' +
                              '3. Clique sur "Autoriser" ou "Allow"\n\n' +
                              'Si tu ne vois pas la popup :\n' +
                              '‚Ä¢ Regarde l\'ic√¥ne üé§ barr√©e dans la barre d\'adresse\n' +
                              '‚Ä¢ Clique dessus et active le microphone';
            } else if (userAgent.includes('safari') && !userAgent.includes('chrome')) {
                browserInfo = '‚úÖ Navigateur d√©tect√© : Safari\n\n' +
                              'Sur Safari, l\'autorisation appara√Æt en haut de l\'√©cran.\n' +
                              'Assure-toi d\'avoir autoris√© Safari √† acc√©der au micro dans les R√©glages de ton iPhone/iPad.';
            } else if (userAgent.includes('edge')) {
                browserInfo = '‚úÖ Navigateur d√©tect√© : Edge\n\n' +
                              'Une popup appara√Ætra en haut demandant l\'autorisation.\n' +
                              'Clique sur "Autoriser".';
            } else if (userAgent.includes('firefox')) {
                browserInfo = '‚ö†Ô∏è Firefox d√©tect√©\n\n' +
                              'ATTENTION : Firefox ne supporte pas bien la reconnaissance vocale en fran√ßais.\n\n' +
                              'Utilise plut√¥t Chrome ou Edge pour cette application.';
            }
            
            console.log(browserInfo);
        }

        // Fonction de test du microphone
        async function testMicrophone() {
            const userAgent = navigator.userAgent.toLowerCase();
            let instructionMsg = 'üé§ Test du microphone\n\n';
            
            if (userAgent.includes('chrome')) {
                instructionMsg += '1. Une popup va appara√Ætre EN HAUT de cette page\n';
                instructionMsg += '2. Cherche l\'ic√¥ne üé§ dans la barre d\'adresse\n';
                instructionMsg += '3. Clique sur "Autoriser" ou "Allow"\n\n';
                instructionMsg += '‚ö†Ô∏è Si tu ne vois rien :\n';
                instructionMsg += '‚Ä¢ Regarde tout en haut de la fen√™tre\n';
                instructionMsg += '‚Ä¢ Clique sur l\'ic√¥ne üé§ barr√©e √† c√¥t√© de l\'adresse';
            } else if (userAgent.includes('safari')) {
                instructionMsg += 'Une demande d\'autorisation va appara√Ætre.\n\n';
                instructionMsg += 'Si rien n\'appara√Æt :\n';
                instructionMsg += '‚Ä¢ Va dans R√©glages > Safari > Microphone\n';
                instructionMsg += '‚Ä¢ Autorise l\'acc√®s au microphone';
            } else {
                instructionMsg += 'Clique sur "Autoriser" quand la popup appara√Æt en haut.';
            }
            
            instructionMsg += '\n\nClique sur OK pour commencer le test.';
            
            alert(instructionMsg);
            
            try {
                console.log('Demande d\'acc√®s au microphone...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                console.log('‚úÖ Acc√®s au microphone obtenu');
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                let maxVolume = 0;
                const testDuration = 2000;
                const startTest = Date.now();
                
                const checkVolume = () => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                    if (average > maxVolume) maxVolume = average;
                    
                    if (Date.now() - startTest < testDuration) {
                        requestAnimationFrame(checkVolume);
                    } else {
                        stream.getTracks().forEach(track => track.stop());
                        audioContext.close();
                        
                        if (maxVolume > 10) {
                            alert('‚úÖ MICROPHONE FONCTIONNEL !\n\n' +
                                  '‚Ä¢ Niveau d√©tect√© : ' + Math.round(maxVolume) + '/255\n' +
                                  '‚Ä¢ Le microphone capte bien du son\n\n' +
                                  'Tu peux maintenant commencer la lecture.\n\n' +
                                  'üí° Conseils :\n' +
                                  '‚Ä¢ Parle clairement\n' +
                                  '‚Ä¢ Reste dans un endroit calme\n' +
                                  '‚Ä¢ Tiens-toi pr√®s du micro');
                        } else {
                            alert('‚ö†Ô∏è Microphone d√©tect√© mais tr√®s peu de son capt√©.\n\n' +
                                  'Niveau : ' + Math.round(maxVolume) + '/255\n\n' +
                                  'V√©rifie que :\n' +
                                  '‚Ä¢ Le micro n\'est pas en mode muet\n' +
                                  '‚Ä¢ Tu parles assez fort\n' +
                                  '‚Ä¢ Le bon micro est s√©lectionn√©\n\n' +
                                  'Essaie de dire "bonjour" et recommence le test.');
                        }
                    }
                };
                
                alert('üé§ Test en cours...\n\nDis "BONJOUR" ou "HELLO" maintenant !\n\nLe test dure 2 secondes.');
                
                checkVolume();
                
            } catch (error) {
                console.error('‚ùå Erreur de test micro:', error);
                
                let errorMessage = '‚ùå PROBL√àME D√âTECT√â :\n\n';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'üö´ Permission refus√©e\n\n';
                    errorMessage += 'Tu as bloqu√© l\'acc√®s au microphone.\n\n';
                    errorMessage += 'SOLUTION :\n';
                    
                    if (userAgent.includes('chrome')) {
                        errorMessage += '1. Clique sur l\'ic√¥ne üé§ ou üîí √† gauche de l\'adresse\n';
                        errorMessage += '2. Trouve "Microphone"\n';
                        errorMessage += '3. Change de "Bloquer" √† "Autoriser"\n';
                        errorMessage += '4. Recharge la page (F5)\n';
                        errorMessage += '5. Clique √† nouveau sur "Tester mon microphone"';
                    } else if (userAgent.includes('safari')) {
                        errorMessage += '1. Va dans Safari > R√©glages pour ce site web\n';
                        errorMessage += '2. Autorise le microphone\n';
                        errorMessage += '3. Recharge la page';
                    } else {
                        errorMessage += '1. Cherche l\'ic√¥ne de permission dans la barre d\'adresse\n';
                        errorMessage += '2. Autorise le microphone\n';
                        errorMessage += '3. Recharge la page';
                    }
                    
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'üé§ Aucun microphone d√©tect√©\n\n';
                    errorMessage += 'SOLUTIONS :\n';
                    errorMessage += '‚Ä¢ V√©rifie qu\'un micro est bien connect√©\n';
                    errorMessage += '‚Ä¢ Sur t√©l√©phone : v√©rifie que le micro n\'est pas bouch√©\n';
                    errorMessage += '‚Ä¢ Essaie avec des √©couteurs avec micro\n';
                    errorMessage += '‚Ä¢ Red√©marre ton appareil';
                    
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '‚ö†Ô∏è Microphone occup√©\n\n';
                    errorMessage += 'Une autre application utilise le micro.\n\n';
                    errorMessage += 'SOLUTIONS :\n';
                    errorMessage += '‚Ä¢ Ferme les autres apps (Zoom, Teams, etc.)\n';
                    errorMessage += '‚Ä¢ Ferme les autres onglets du navigateur\n';
                    errorMessage += '‚Ä¢ Red√©marre le navigateur';
                    
                } else {
                    errorMessage += 'Erreur : ' + error.name + '\n';
                    errorMessage += error.message + '\n\n';
                    errorMessage += 'Essaie de :\n';
                    errorMessage += '‚Ä¢ Recharger la page\n';
                    errorMessage += '‚Ä¢ Red√©marrer le navigateur\n';
                    errorMessage += '‚Ä¢ Utiliser Chrome ou Safari';
                }
                
                alert(errorMessage);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'progres') {
                updateProgressCharts();
            } else if (tabName === 'resultats') {
                updateStats();
            }
        }

        function selectDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadNewText();
        }

        function loadNewText() {
            const selection = selectText();
            const textsArray = texts[currentDifficulty];
            
            currentTextId = selection.index;
            currentTextType = selection.type;
            currentText = textsArray[currentTextId];
            currentWords = currentText.split(' ');
            
            const textDiv = document.getElementById('textToRead');
            textDiv.innerHTML = currentWords.map((word, i) => 
                `<span class="word" id="word-${i}">${word}</span>`
            ).join(' ');

            // Afficher le type de texte
            let typeLabel = '';
            let typeColor = '';
            if (currentTextType === 'evaluation') {
                typeLabel = 'üìä Texte d\'√©valuation';
                typeColor = '#0066cc';
            } else if (currentTextType === 'revision') {
                typeLabel = 'üîÑ Texte √† retravailler';
                typeColor = '#ff9800';
            } else {
                typeLabel = '‚ú® Nouveau texte';
                typeColor = '#28a745';
            }
            
            const typeIndicator = document.createElement('div');
            typeIndicator.style.cssText = `
                background: ${typeColor}15;
                border-left: 4px solid ${typeColor};
                padding: 10px 15px;
                border-radius: 6px;
                margin-bottom: 15px;
                color: ${typeColor};
                font-weight: 600;
            `;
            typeIndicator.textContent = typeLabel;
            
            textDiv.parentElement.insertBefore(typeIndicator, textDiv);

            document.getElementById('currentResults').style.display = 'none';
            sessionData = {
                wordsRead: 0,
                correctWords: 0,
                totalWords: currentWords.length,
                difficulty: currentDifficulty,
                transcript: '',
                textId: currentTextId,
                textType: currentTextType
            };
        }

        async function startReading() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('‚ö†Ô∏è La reconnaissance vocale n\'est pas disponible sur ce navigateur.\n\nUtilisez Chrome, Edge ou Safari pour cette fonctionnalit√©.');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;

                startTime = Date.now();
                isRecording = true;

                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingIndicator').classList.add('active');

                let finalTranscript = '';

                recognition.onstart = () => {
                    console.log('üé§ Reconnaissance vocale d√©marr√©e');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                            console.log('Texte reconnu:', transcript);
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    sessionData.transcript = finalTranscript.trim();
                    analyzeReading(finalTranscript.toLowerCase());
                };

                recognition.onerror = (event) => {
                    console.error('Erreur de reconnaissance:', event.error);
                    
                    let errorMessage = '';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'üé§ Aucune parole d√©tect√©e.\n\nAssure-toi de parler assez fort et que ton microphone fonctionne.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'üé§ Impossible d\'acc√©der au microphone.\n\nV√©rifie que :\n- Le microphone est bien connect√©\n- Tu as autoris√© l\'acc√®s au micro\n- Aucune autre app n\'utilise le micro';
                            break;
                        case 'not-allowed':
                            errorMessage = 'üö´ Permission refus√©e.\n\nTu dois autoriser l\'acc√®s au microphone pour utiliser cette fonctionnalit√©.\n\nRecharge la page et clique sur "Autoriser" quand demand√©.';
                            isRecording = false;
                            document.getElementById('startBtn').disabled = false;
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('recordingIndicator').classList.remove('active');
                            break;
                        case 'network':
                            errorMessage = 'üåê Erreur r√©seau.\n\nLa reconnaissance vocale n√©cessite une connexion internet.';
                            break;
                        default:
                            errorMessage = `‚ö†Ô∏è Erreur: ${event.error}\n\nEssaie de recharger la page.`;
                    }
                    
                    if (errorMessage && event.error !== 'no-speech') {
                        alert(errorMessage);
                    }
                };

                recognition.onend = () => {
                    console.log('Reconnaissance termin√©e');
                    if (isRecording) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('Erreur lors du red√©marrage:', e);
                        }
                    }
                };

                recognition.start();
                
            } catch (error) {
                console.error('Erreur d\'acc√®s au microphone:', error);
                
                let errorMessage = 'üé§ Impossible d\'acc√©der au microphone.\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Tu as refus√© l\'acc√®s au microphone.\n\nRecharge la page et clique sur "Autoriser" quand ton navigateur te le demande.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'Aucun microphone d√©tect√©.\n\nV√©rifie qu\'un microphone est bien connect√© √† ton appareil.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Le microphone est peut-√™tre utilis√© par une autre application.\n\nFerme les autres apps qui utilisent le micro et r√©essaie.';
                } else {
                    errorMessage += 'Erreur: ' + error.message;
                }
                
                alert(errorMessage);
            }
        }

        function stopReading() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recordingIndicator').classList.remove('active');

            calculateResults();
            saveSession();
            displayResults();
        }

        function analyzeReading(spokenText) {
            const spokenWords = spokenText.split(/\s+/).filter(w => w.length > 0);
            const textWords = currentWords.map(w => w.toLowerCase().replace(/[.,!?;:¬´¬ª'"]/g, ''));
            
            let matchCount = 0;
            
            const normalizedSpoken = spokenWords.map(w => w.replace(/[.,!?;:¬´¬ª'"]/g, ''));
            
            textWords.forEach((word, index) => {
                const wordElement = document.getElementById(`word-${index}`);
                
                const isMatched = normalizedSpoken.some(spoken => {
                    if (spoken === word) return true;
                    
                    if (spoken.includes(word) && word.length > 3) return true;
                    if (word.includes(spoken) && spoken.length > 3) return true;
                    
                    const maxDistance = word.length <= 4 ? 1 : Math.floor(word.length / 4);
                    if (levenshteinDistance(spoken, word) <= maxDistance) return true;
                    
                    if (word.length > 4 && spoken.length > 4) {
                        if (word.substring(0, 4) === spoken.substring(0, 4)) return true;
                    }
                    
                    return false;
                });
                
                if (isMatched) {
                    wordElement.classList.add('correct');
                    wordElement.classList.remove('incorrect');
                    matchCount++;
                } else if (normalizedSpoken.length > index) {
                    wordElement.classList.add('incorrect');
                    wordElement.classList.remove('correct');
                }
            });

            sessionData.wordsRead = spokenWords.length;
            sessionData.correctWords = matchCount;
            
            console.log(`Mots reconnus: ${matchCount}/${textWords.length} (${Math.round(matchCount/textWords.length*100)}%)`);
        }

        function levenshteinDistance(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[b.length][a.length];
        }

        function calculateResults() {
            sessionData.accuracy = sessionData.totalWords > 0 
                ? Math.round((sessionData.correctWords / sessionData.totalWords) * 100) 
                : 0;
            
            sessionData.date = new Date().toISOString();
            
            // Marquer le texte comme utilis√© et g√©rer les difficult√©s
            markTextAsUsed(currentTextId, sessionData.accuracy);
        }

        function displayResults() {
            const resultsDiv = document.getElementById('sessionResults');
            const accuracy = sessionData.accuracy;
            
            let feedback = '';
            let feedbackClass = '';
            let tips = [];

            if (accuracy >= 90) {
                feedback = 'üéâ Excellent ! La plupart des mots ont √©t√© bien reconnus !';
                feedbackClass = 'feedback-positive';
                tips = [
                    'Excellente reconnaissance des mots',
                    'Tu peux essayer un niveau plus difficile',
                    'Continue √† lire r√©guli√®rement'
                ];
            } else if (accuracy >= 75) {
                feedback = 'üëç Tr√®s bon travail ! Bonne reconnaissance globale.';
                feedbackClass = 'feedback-positive';
                tips = [
                    'La majorit√© des mots ont √©t√© reconnus',
                    'Regarde les mots en rouge : ce sont ceux √† travailler',
                    'Essaye de bien articuler ces mots difficiles'
                ];
            } else if (accuracy >= 60) {
                feedback = 'üí™ Bon d√©but ! Certains mots posent encore des difficult√©s.';
                feedbackClass = 'feedback-warning';
                tips = [
                    'Les mots en rouge sont ceux qui n\'ont pas √©t√© bien capt√©s',
                    'Articule bien chaque syllabe',
                    'Relis le texte en te concentrant sur les mots difficiles',
                    'Note : le micro peut aussi avoir manqu√© certains mots'
                ];
            } else {
                feedback = 'üåü Continue ! Le micro a eu du mal √† capter beaucoup de mots.';
                feedbackClass = 'feedback-warning';
                tips = [
                    'V√©rifie que le microphone fonctionne bien',
                    'Parle plus fort et articule davantage',
                    '√âlimine les bruits de fond',
                    'Lis plus lentement en pronon√ßant bien',
                    'Un score faible peut venir du micro, pas forc√©ment de ta lecture !'
                ];
            }

            // Identifier les mots non reconnus
            const missedWords = [];
            currentWords.forEach((word, index) => {
                const wordElement = document.getElementById(`word-${index}`);
                if (wordElement && wordElement.classList.contains('incorrect')) {
                    missedWords.push(word);
                }
            });

            resultsDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Mots reconnus correctement :</span>
                    <span class="metric-value">${sessionData.correctWords} / ${sessionData.totalWords}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Taux de pr√©cision :</span>
                    <span class="metric-value">${accuracy}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${accuracy}%">${accuracy}%</div>
                </div>
                
                ${missedWords.length > 0 ? `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üéØ Mots √† retravailler :</h4>
                    <p style="color: #856404; font-weight: 600;">${missedWords.join(', ')}</p>
                </div>
                ` : ''}
                
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #0066cc;">
                    <p style="color: #0066cc; font-size: 14px; margin: 0;">
                        <strong>‚ÑπÔ∏è Important :</strong> La pr√©cision mesure quels mots ont √©t√© reconnus par le microphone. 
                        Les mots en <span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">vert</span> ont √©t√© bien capt√©s, 
                        ceux en <span style="background: #f8d7da; padding: 2px 6px; border-radius: 3px;">rouge</span> sont √† retravailler 
                        (ou n'ont pas √©t√© bien capt√©s par le micro).
                    </p>
                </div>
                
                <div class="feedback ${feedbackClass}" style="margin-top: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">${feedback}</h4>
                </div>
                
                <div class="tips">
                    <h4>üí° Observations :</h4>
                    <ul>
                        ${tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>
            `;

            document.getElementById('currentResults').style.display = 'block';
            updateStats();
        }

        function saveSession() {
            let history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            history.push(sessionData);
            localStorage.setItem('readingHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            const historyDiv = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>Aucune s√©ance enregistr√©e pour le moment.</p>
                        <p style="margin-top: 10px; color: #666;">Commence une lecture pour voir tes progr√®s ici !</p>
                    </div>
                `;
                return;
            }

            historyDiv.innerHTML = history.slice().reverse().map((session, index) => {
                const realIndex = history.length - 1 - index;
                const date = new Date(session.date);
                const difficultyLabel = {
                    'facile': '‚≠ê Facile',
                    'moyen': '‚≠ê‚≠ê Moyen',
                    'difficile': '‚≠ê‚≠ê‚≠ê Difficile'
                }[session.difficulty];

                const typeLabel = {
                    'evaluation': 'üìä √âvaluation',
                    'revision': 'üîÑ R√©vision',
                    'nouveau': '‚ú® Nouveau'
                }[session.textType] || '‚ú® Nouveau';

                const typeColor = {
                    'evaluation': '#0066cc',
                    'revision': '#ff9800',
                    'nouveau': '#28a745'
                }[session.textType] || '#28a745';

                return `
                    <div class="history-item">
                        <h4>${date.toLocaleDateString('fr-FR')} - ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</h4>
                        <p><strong>Niveau :</strong> ${difficultyLabel} | <span style="color: ${typeColor}; font-weight: 600;">${typeLabel}</span></p>
                        <p><strong>Pr√©cision :</strong> ${session.accuracy}% (${session.correctWords}/${session.totalWords} mots reconnus)</p>
                        <button class="btn btn-danger" onclick="deleteSession(${realIndex})" style="margin-top: 10px; padding: 8px 15px; font-size: 14px;">
                            üóëÔ∏è Supprimer cette s√©ance
                        </button>
                    </div>
                `;
            }).join('');
        }

        function deleteSession(index) {
            if (confirm('Voulez-vous vraiment supprimer cette s√©ance ?\n\nCette action est irr√©versible.')) {
                let history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
                history.splice(index, 1);
                localStorage.setItem('readingHistory', JSON.stringify(history));
                loadHistory();
                updateStats();
                updateProgressCharts();
                alert('‚úÖ S√©ance supprim√©e avec succ√®s !');
            }
        }

        function updateStats() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            if (history.length === 0) {
                document.getElementById('overallStats').innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üìä</div>
                        <p>Commence √† lire pour voir tes statistiques !</p>
                    </div>
                `;
                document.getElementById('lastSessionDetails').innerHTML = '';
                return;
            }

            const totalSessions = history.length;
            const avgAccuracy = Math.round(
                history.reduce((sum, s) => sum + s.accuracy, 0) / totalSessions
            );
            const lastSession = history[history.length - 1];

            document.getElementById('overallStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${totalSessions}</div>
                    <div class="stat-label">S√©ances</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${avgAccuracy}%</div>
                    <div class="stat-label">Pr√©cision moyenne</div>
                </div>
            `;

            const difficultyLabel = {
                'facile': '‚≠ê Facile',
                'moyen': '‚≠ê‚≠ê Moyen',
                'difficile': '‚≠ê‚≠ê‚≠ê Difficile'
            }[lastSession.difficulty];

            document.getElementById('lastSessionDetails').innerHTML = `
                <div class="results-card" style="margin-top: 20px;">
                    <h3>üìñ Derni√®re s√©ance</h3>
                    <div class="metric">
                        <span class="metric-label">Date :</span>
                        <span class="metric-value">${new Date(lastSession.date).toLocaleString('fr-FR')}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Niveau :</span>
                        <span class="metric-value">${difficultyLabel}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Pr√©cision :</span>
                        <span class="metric-value">${lastSession.accuracy}%</span>
                    </div>
                </div>
            `;
        }

        let progressChart = null;
        let evaluationChart = null;
        let textTypeChart = null;

        function updateProgressCharts() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            if (history.length === 0) {
                return;
            }

            // Graphique d'√©volution g√©n√©rale
            const ctx1 = document.getElementById('progressChart').getContext('2d');
            
            if (progressChart) progressChart.destroy();

            const dates = history.map(s => new Date(s.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'}));
            
            progressChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Pr√©cision (%)',
                            data: history.map(s => s.accuracy),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Graphique sp√©cifique aux textes d'√©valuation
            const evalHistory = history.filter(s => s.textType === 'evaluation');
            if (evalHistory.length > 0) {
                const ctx2 = document.getElementById('evaluationChart').getContext('2d');
                
                if (evaluationChart) evaluationChart.destroy();

                const evalDates = evalHistory.map(s => new Date(s.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'}));
                
                evaluationChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: evalDates,
                        datasets: [
                            {
                                label: 'Pr√©cision sur textes de r√©f√©rence',
                                data: evalHistory.map(s => s.accuracy),
                                borderColor: '#0066cc',
                                backgroundColor: 'rgba(0, 102, 204, 0.2)',
                                tension: 0.4,
                                fill: true,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 10
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // Graphique de r√©partition par type
            const ctx3 = document.getElementById('textTypeChart').getContext('2d');
            
            if (textTypeChart) textTypeChart.destroy();

            const typeCounts = {
                evaluation: history.filter(s => s.textType === 'evaluation').length,
                nouveau: history.filter(s => s.textType === 'nouveau').length,
                revision: history.filter(s => s.textType === 'revision').length
            };

            textTypeChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: ['üìä √âvaluation', '‚ú® Nouveaux', 'üîÑ R√©visions'],
                    datasets: [{
                        data: [typeCounts.evaluation, typeCounts.nouveau, typeCounts.revision],
                        backgroundColor: [
                            'rgba(0, 102, 204, 0.6)',
                            'rgba(40, 167, 69, 0.6)',
                            'rgba(255, 152, 0, 0.6)'
                        ],
                        borderColor: [
                            'rgba(0, 102, 204, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 152, 0, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Liste des textes difficiles
            updateDifficultTextsList();
        }

        function updateDifficultTextsList() {
            const state = getTextState();
            const difficultTexts = state.difficultTexts[currentDifficulty] || [];
            const listDiv = document.getElementById('difficultTextsList');

            if (difficultTexts.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #28a745;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üéâ</div>
                        <p style="font-weight: 600;">Aucun texte en difficult√© !</p>
                        <p style="color: #666; font-size: 14px; margin-top: 5px;">Tous les textes sont bien ma√Ætris√©s.</p>
                    </div>
                `;
                return;
            }

            listDiv.innerHTML = difficultTexts.map(dt => {
                const daysSince = Math.floor((Date.now() - new Date(dt.lastAttempt).getTime()) / (1000 * 60 * 60 * 24));
                const canRetry = daysSince >= 7;

                return `
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ff9800;">
                        <p style="color: #666; font-size: 14px; margin-bottom: 5px;">
                            Texte #${dt.textId + 1} - Derni√®re tentative : ${dt.lastAccuracy}%
                        </p>
                        <p style="color: #666; font-size: 12px;">
                            ${canRetry ? 
                                '‚úÖ Pr√™t √† √™tre retravaill√©' : 
                                `‚è≥ √Ä revoir dans ${7 - daysSince} jour(s)`
                            }
                        </p>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>