<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur Interactif - Analyse Vocale</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .text-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .text-to-read {
            font-size: 20px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 20px;
        }

        .text-to-read .word {
            display: inline;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .text-to-read .word.current {
            background: #fff3cd;
            font-weight: 600;
        }

        .text-to-read .word.correct {
            background: #d4edda;
        }

        .text-to-read .word.incorrect {
            background: #f8d7da;
        }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-btn.active {
            background: #667eea;
            color: white;
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            margin: 20px 0;
        }

        .recording-indicator.active {
            display: flex;
        }

        .pulse {
            width: 20px;
            height: 20px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .results-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .results-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .metric-value {
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .history-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .history-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .feedback {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .feedback-positive {
            border-left: 4px solid #28a745;
        }

        .feedback-warning {
            border-left: 4px solid #ffc107;
        }

        .tips {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tips h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .tips ul {
            margin-left: 20px;
        }

        .tips li {
            margin-bottom: 5px;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .control-buttons {
                flex-direction: column;
            }
            
            .difficulty-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Lecteur Interactif</h1>
            <p>Analyse vocale et suivi des progr√®s en lecture</p>
        </div>

        <div class="content">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('lecture')">üìñ Lecture</button>
                <button class="tab-btn" onclick="switchTab('resultats')">üìä R√©sultats</button>
                <button class="tab-btn" onclick="switchTab('progres')">üìà Progr√®s</button>
            </div>

            <!-- Onglet Lecture -->
            <div id="lecture-tab" class="tab-content active">
                <div class="text-card">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Choisis le niveau de difficult√© :</h3>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn active" onclick="selectDifficulty('facile')">‚≠ê Facile (CP-CE1)</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('moyen')">‚≠ê‚≠ê Moyen (CE2)</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('difficile')">‚≠ê‚≠ê‚≠ê Difficile (CM1-CM2)</button>
                    </div>
                </div>

                <div class="text-card">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Texte √† lire :</h3>
                    <div class="text-to-read" id="textToRead"></div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üí° Avant de commencer :</h4>
                        <ul style="margin-left: 20px; color: #856404;">
                            <li>Assure-toi d'√™tre dans un endroit calme</li>
                            <li>Parle clairement et pas trop vite</li>
                            <li>Tiens-toi pr√®s du microphone</li>
                            <li>Autorise l'acc√®s au micro quand ton navigateur te le demande</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="testMicrophone()" style="margin-top: 10px; font-size: 14px; padding: 10px 15px;">
                            üé§ Tester mon microphone
                        </button>
                    </div>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <div class="pulse"></div>
                    <span style="font-weight: 600;">üé§ Enregistrement en cours... Lis le texte √† voix haute</span>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" id="startBtn" onclick="startReading()">
                        üé§ Commencer la lecture
                    </button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopReading()" disabled>
                        ‚èπÔ∏è Terminer
                    </button>
                    <button class="btn btn-secondary" onclick="loadNewText()">
                        üîÑ Nouveau texte
                    </button>
                </div>

                <div class="results-card" id="currentResults" style="display: none;">
                    <h3>üìä R√©sultats de cette lecture</h3>
                    <div id="sessionResults"></div>
                </div>
            </div>

            <!-- Onglet R√©sultats -->
            <div id="resultats-tab" class="tab-content">
                <div class="stats-grid" id="overallStats"></div>
                <div id="lastSessionDetails"></div>
            </div>

            <!-- Onglet Progr√®s -->
            <div id="progres-tab" class="tab-content">
                <div class="chart-container">
                    <h3>üìà √âvolution des Performances</h3>
                    <canvas id="progressChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>üìä R√©partition des Niveaux de Difficult√©</h3>
                    <canvas id="difficultyChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üìú Historique des S√©ances</h3>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Textes de lecture par niveau
        const texts = {
            facile: [
                "Le chat est sur le tapis. Il dort au soleil. Il est tout doux.",
                "Papa lit un livre. Maman fait un g√¢teau. Je joue avec mon ballon.",
                "Dans le jardin, il y a des fleurs. Les fleurs sont jolies. J'aime les roses rouges.",
                "Mon ami s'appelle Tom. Il a un v√©lo bleu. Nous allons au parc ensemble.",
                "Le soleil brille dans le ciel. Les oiseaux chantent. C'est une belle journ√©e."
            ],
            moyen: [
                "L√©a adore les animaux. Chaque mercredi, elle va √† la ferme avec son grand-p√®re. Elle donne √† manger aux poules et aux lapins. C'est son moment pr√©f√©r√© de la semaine.",
                "Dans la for√™t, les arbres sont tr√®s hauts. Les √©cureuils sautent de branche en branche. Parfois, on peut voir des biches qui se prom√®nent tranquillement.",
                "Pierre collectionne les cailloux. Il a trouv√© un cristal brillant pr√®s de la rivi√®re. C'est son plus beau tr√©sor. Il le montre fi√®rement √† tous ses amis.",
                "La biblioth√®que du quartier est immense. Marie y va tous les samedis. Elle emprunte des livres d'aventures et de sciences. La biblioth√©caire est tr√®s gentille.",
                "Pendant les vacances, nous sommes all√©s √† la mer. J'ai construit un ch√¢teau de sable √©norme. Les vagues venaient doucement le mouiller. C'√©tait magnifique."
            ],
            difficile: [
                "L'exploration spatiale fascine les scientifiques depuis des d√©cennies. Les astronautes s'entra√Ænent pendant des ann√©es avant de partir en mission. Ils doivent apprendre √† vivre en apesanteur et √† r√©soudre des probl√®mes complexes dans des situations d'urgence.",
                "Les volcans sont des montagnes particuli√®res qui peuvent entrer en √©ruption. Le magma, cette roche en fusion venue des profondeurs de la Terre, remonte √† la surface. Quand il jaillit, on l'appelle de la lave. Les √©ruptions volcaniques peuvent √™tre spectaculaires mais aussi dangereuses.",
                "Au Moyen √Çge, les ch√¢teaux forts prot√©geaient les seigneurs et leurs familles. Ces imposantes forteresses √©taient entour√©es de douves remplies d'eau. Des pont-levis permettaient d'entrer et de sortir. Les soldats surveillaient les environs depuis les hautes tours.",
                "La photosynth√®se est un ph√©nom√®ne extraordinaire. Gr√¢ce √† la lumi√®re du soleil, les plantes transforment le dioxyde de carbone en oxyg√®ne. Ce processus est essentiel √† la vie sur Terre car il permet de purifier l'air que nous respirons.",
                "Les migrations des oiseaux restent myst√©rieuses. Chaque ann√©e, certaines esp√®ces parcourent des milliers de kilom√®tres. Elles traversent des oc√©ans et des continents pour retrouver des climats plus cl√©ments. Leur sens de l'orientation est remarquable."
            ]
        };

        let currentDifficulty = 'facile';
        let currentText = '';
        let currentWords = [];
        let recognition = null;
        let isRecording = false;
        let startTime = null;
        let sessionData = {
            wordsRead: 0,
            correctWords: 0,
            totalWords: 0,
            duration: 0,
            difficulty: '',
            transcript: ''
        };

        // Initialisation
        window.addEventListener('load', () => {
            loadNewText();
            loadHistory();
            updateStats();
            updateProgressCharts();
            
            // V√©rifier la compatibilit√© de la reconnaissance vocale
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('‚ö†Ô∏è Votre navigateur ne supporte pas la reconnaissance vocale.\n\nUtilisez Chrome, Edge ou Safari pour cette fonctionnalit√©.');
            }
        });

        // Fonction de test du microphone
        async function testMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                alert('‚úÖ Microphone d√©tect√© et fonctionnel !\n\nTu peux maintenant commencer la lecture.\n\nN\'oublie pas : parle clairement et dans un endroit calme.');
                
                // Arr√™ter le stream
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                console.error('Erreur de test micro:', error);
                
                let errorMessage = '‚ùå Probl√®me avec le microphone :\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Tu as refus√© l\'acc√®s au microphone.\n\nRecharge la page et clique sur "Autoriser" quand ton navigateur te le demande.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'Aucun microphone d√©tect√©.\n\nV√©rifie qu\'un microphone est bien connect√© √† ton appareil.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Le microphone est peut-√™tre utilis√© par une autre application.\n\nFerme les autres apps et r√©essaie.';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            }
        }

        function switchTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Afficher l'onglet s√©lectionn√©
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Mettre √† jour les donn√©es si n√©cessaire
            if (tabName === 'progres') {
                updateProgressCharts();
            } else if (tabName === 'resultats') {
                updateStats();
            }
        }

        function selectDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadNewText();
        }

        function loadNewText() {
            const textArray = texts[currentDifficulty];
            currentText = textArray[Math.floor(Math.random() * textArray.length)];
            currentWords = currentText.split(' ');
            
            const textDiv = document.getElementById('textToRead');
            textDiv.innerHTML = currentWords.map((word, i) => 
                `<span class="word" id="word-${i}">${word}</span>`
            ).join(' ');

            // R√©initialiser les r√©sultats
            document.getElementById('currentResults').style.display = 'none';
            sessionData = {
                wordsRead: 0,
                correctWords: 0,
                totalWords: currentWords.length,
                duration: 0,
                difficulty: currentDifficulty,
                transcript: ''
            };
        }

        async function startReading() {
            // V√©rifier la compatibilit√© du navigateur
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('‚ö†Ô∏è La reconnaissance vocale n\'est pas disponible sur ce navigateur.\n\nUtilisez Chrome, Edge ou Safari pour cette fonctionnalit√©.');
                return;
            }

            try {
                // Demander explicitement la permission d'acc√®s au microphone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Arr√™ter le stream imm√©diatement (on voulait juste la permission)
                stream.getTracks().forEach(track => track.stop());
                
                // Maintenant qu'on a la permission, d√©marrer la reconnaissance vocale
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;

                startTime = Date.now();
                isRecording = true;

                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingIndicator').classList.add('active');

                let finalTranscript = '';

                recognition.onstart = () => {
                    console.log('üé§ Reconnaissance vocale d√©marr√©e');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                            console.log('Texte reconnu:', transcript);
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    sessionData.transcript = finalTranscript.trim();
                    analyzeReading(finalTranscript.toLowerCase());
                };

                recognition.onerror = (event) => {
                    console.error('Erreur de reconnaissance:', event.error);
                    
                    let errorMessage = '';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'üé§ Aucune parole d√©tect√©e.\n\nAssure-toi de parler assez fort et que ton microphone fonctionne.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'üé§ Impossible d\'acc√©der au microphone.\n\nV√©rifie que :\n- Le microphone est bien connect√©\n- Tu as autoris√© l\'acc√®s au micro\n- Aucune autre app n\'utilise le micro';
                            break;
                        case 'not-allowed':
                            errorMessage = 'üö´ Permission refus√©e.\n\nTu dois autoriser l\'acc√®s au microphone pour utiliser cette fonctionnalit√©.\n\nRecharge la page et clique sur "Autoriser" quand demand√©.';
                            isRecording = false;
                            document.getElementById('startBtn').disabled = false;
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('recordingIndicator').classList.remove('active');
                            break;
                        case 'network':
                            errorMessage = 'üåê Erreur r√©seau.\n\nLa reconnaissance vocale n√©cessite une connexion internet.';
                            break;
                        default:
                            errorMessage = `‚ö†Ô∏è Erreur: ${event.error}\n\nEssaie de recharger la page.`;
                    }
                    
                    if (errorMessage && event.error !== 'no-speech') {
                        alert(errorMessage);
                    }
                };

                recognition.onend = () => {
                    console.log('Reconnaissance termin√©e');
                    if (isRecording) {
                        try {
                            recognition.start(); // Red√©marrer pour continuer l'√©coute
                        } catch (e) {
                            console.error('Erreur lors du red√©marrage:', e);
                        }
                    }
                };

                recognition.start();
                
            } catch (error) {
                console.error('Erreur d\'acc√®s au microphone:', error);
                
                let errorMessage = 'üé§ Impossible d\'acc√©der au microphone.\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Tu as refus√© l\'acc√®s au microphone.\n\nRecharge la page et clique sur "Autoriser" quand ton navigateur te le demande.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'Aucun microphone d√©tect√©.\n\nV√©rifie qu\'un microphone est bien connect√© √† ton appareil.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Le microphone est peut-√™tre utilis√© par une autre application.\n\nFerme les autres apps qui utilisent le micro et r√©essaie.';
                } else {
                    errorMessage += 'Erreur: ' + error.message;
                }
                
                alert(errorMessage);
            }
        }

        function stopReading() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }

            sessionData.duration = Math.round((Date.now() - startTime) / 1000);

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recordingIndicator').classList.remove('active');

            // Calculer les r√©sultats finaux
            calculateResults();
            saveSession();
            displayResults();
        }

        function analyzeReading(spokenText) {
            const spokenWords = spokenText.split(/\s+/).filter(w => w.length > 0);
            const textWords = currentWords.map(w => w.toLowerCase().replace(/[.,!?]/g, ''));
            
            let matchCount = 0;
            
            textWords.forEach((word, index) => {
                const wordElement = document.getElementById(`word-${index}`);
                
                // Chercher le mot dans ce qui a √©t√© dit
                if (spokenWords.some(spoken => {
                    // Correspondance exacte ou similaire (pour g√©rer les variations)
                    return spoken === word || 
                           spoken.includes(word) || 
                           word.includes(spoken) ||
                           levenshteinDistance(spoken, word) <= 1;
                })) {
                    wordElement.classList.add('correct');
                    wordElement.classList.remove('incorrect');
                    matchCount++;
                } else if (spokenWords.length > index) {
                    wordElement.classList.add('incorrect');
                    wordElement.classList.remove('correct');
                }
            });

            sessionData.wordsRead = spokenWords.length;
            sessionData.correctWords = matchCount;
        }

        function levenshteinDistance(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[b.length][a.length];
        }

        function calculateResults() {
            sessionData.accuracy = sessionData.totalWords > 0 
                ? Math.round((sessionData.correctWords / sessionData.totalWords) * 100) 
                : 0;
            
            sessionData.wordsPerMinute = sessionData.duration > 0 
                ? Math.round((sessionData.correctWords / sessionData.duration) * 60) 
                : 0;
            
            sessionData.date = new Date().toISOString();
        }

        function displayResults() {
            const resultsDiv = document.getElementById('sessionResults');
            const accuracy = sessionData.accuracy;
            
            let feedback = '';
            let feedbackClass = '';
            let tips = [];

            if (accuracy >= 90) {
                feedback = 'üéâ Excellent travail ! Ta lecture est tr√®s pr√©cise !';
                feedbackClass = 'feedback-positive';
                tips = [
                    'Tu peux essayer un niveau plus difficile',
                    'Continue √† lire r√©guli√®rement pour maintenir ce niveau',
                    'Essaye de lire encore plus vite tout en gardant cette pr√©cision'
                ];
            } else if (accuracy >= 70) {
                feedback = 'üëç Bon travail ! Tu fais des progr√®s !';
                feedbackClass = 'feedback-positive';
                tips = [
                    'Essaye de bien prononcer chaque mot',
                    'Prends ton temps pour les mots difficiles',
                    'Relis le texte une deuxi√®me fois pour am√©liorer ton score'
                ];
            } else if (accuracy >= 50) {
                feedback = 'üí™ Continue tes efforts ! Tu es sur la bonne voie.';
                feedbackClass = 'feedback-warning';
                tips = [
                    'Lis d\'abord le texte en silence avant de commencer',
                    'Articule bien chaque syllabe',
                    'N\'h√©site pas √† demander de l\'aide pour les mots difficiles',
                    'Essaye peut-√™tre un niveau plus facile pour prendre confiance'
                ];
            } else {
                feedback = 'üåü Ne te d√©courage pas ! La lecture demande de la pratique.';
                feedbackClass = 'feedback-warning';
                tips = [
                    'Choisis un niveau plus facile pour commencer',
                    'Demande √† un adulte de lire le texte avec toi d\'abord',
                    'Fais des pauses et prends ton temps',
                    'Pratique tous les jours, m√™me 5 minutes, √ßa aide beaucoup !'
                ];
            }

            resultsDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Mots lus correctement :</span>
                    <span class="metric-value">${sessionData.correctWords} / ${sessionData.totalWords}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pr√©cision :</span>
                    <span class="metric-value">${accuracy}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${accuracy}%">${accuracy}%</div>
                </div>
                <div class="metric" style="margin-top: 10px;">
                    <span class="metric-label">Vitesse de lecture :</span>
                    <span class="metric-value">${sessionData.wordsPerMinute} mots/min</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Dur√©e :</span>
                    <span class="metric-value">${sessionData.duration} secondes</span>
                </div>
                
                <div class="feedback ${feedbackClass}" style="margin-top: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">${feedback}</h4>
                </div>
                
                <div class="tips">
                    <h4>üí° Conseils pour progresser :</h4>
                    <ul>
                        ${tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>
            `;

            document.getElementById('currentResults').style.display = 'block';
            updateStats();
        }

        function saveSession() {
            let history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            history.push(sessionData);
            localStorage.setItem('readingHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            const historyDiv = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>Aucune s√©ance enregistr√©e pour le moment.</p>
                        <p style="margin-top: 10px; color: #666;">Commence une lecture pour voir tes progr√®s ici !</p>
                    </div>
                `;
                return;
            }

            historyDiv.innerHTML = history.slice().reverse().map((session, index) => {
                const date = new Date(session.date);
                const difficultyLabel = {
                    'facile': '‚≠ê Facile',
                    'moyen': '‚≠ê‚≠ê Moyen',
                    'difficile': '‚≠ê‚≠ê‚≠ê Difficile'
                }[session.difficulty];

                return `
                    <div class="history-item">
                        <h4>${date.toLocaleDateString('fr-FR')} - ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</h4>
                        <p><strong>Niveau :</strong> ${difficultyLabel}</p>
                        <p><strong>Pr√©cision :</strong> ${session.accuracy}% (${session.correctWords}/${session.totalWords} mots)</p>
                        <p><strong>Vitesse :</strong> ${session.wordsPerMinute} mots/min</p>
                        <p><strong>Dur√©e :</strong> ${session.duration}s</p>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            if (history.length === 0) {
                document.getElementById('overallStats').innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üìä</div>
                        <p>Commence √† lire pour voir tes statistiques !</p>
                    </div>
                `;
                document.getElementById('lastSessionDetails').innerHTML = '';
                return;
            }

            const totalSessions = history.length;
            const avgAccuracy = Math.round(
                history.reduce((sum, s) => sum + s.accuracy, 0) / totalSessions
            );
            const avgSpeed = Math.round(
                history.reduce((sum, s) => sum + s.wordsPerMinute, 0) / totalSessions
            );
            const lastSession = history[history.length - 1];

            document.getElementById('overallStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${totalSessions}</div>
                    <div class="stat-label">S√©ances</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${avgAccuracy}%</div>
                    <div class="stat-label">Pr√©cision moyenne</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${avgSpeed}</div>
                    <div class="stat-label">Mots/min moyens</div>
                </div>
            `;

            const difficultyLabel = {
                'facile': '‚≠ê Facile',
                'moyen': '‚≠ê‚≠ê Moyen',
                'difficile': '‚≠ê‚≠ê‚≠ê Difficile'
            }[lastSession.difficulty];

            document.getElementById('lastSessionDetails').innerHTML = `
                <div class="results-card" style="margin-top: 20px;">
                    <h3>üìñ Derni√®re s√©ance</h3>
                    <div class="metric">
                        <span class="metric-label">Date :</span>
                        <span class="metric-value">${new Date(lastSession.date).toLocaleString('fr-FR')}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Niveau :</span>
                        <span class="metric-value">${difficultyLabel}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Pr√©cision :</span>
                        <span class="metric-value">${lastSession.accuracy}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Vitesse :</span>
                        <span class="metric-value">${lastSession.wordsPerMinute} mots/min</span>
                    </div>
                </div>
            `;
        }

        let progressChart = null;
        let difficultyChart = null;

        function updateProgressCharts() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            if (history.length === 0) {
                return;
            }

            // Graphique de progression
            const ctx1 = document.getElementById('progressChart').getContext('2d');
            
            if (progressChart) progressChart.destroy();

            const dates = history.map(s => new Date(s.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'}));
            
            progressChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Pr√©cision (%)',
                            data: history.map(s => s.accuracy),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Vitesse (mots/min)',
                            data: history.map(s => s.wordsPerMinute),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Pr√©cision (%)'
                            },
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Vitesse (mots/min)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });

            // Graphique de difficult√©
            const ctx2 = document.getElementById('difficultyChart').getContext('2d');
            
            if (difficultyChart) difficultyChart.destroy();

            const difficultyCounts = {
                facile: history.filter(s => s.difficulty === 'facile').length,
                moyen: history.filter(s => s.difficulty === 'moyen').length,
                difficile: history.filter(s => s.difficulty === 'difficile').length
            };

            difficultyChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['‚≠ê Facile', '‚≠ê‚≠ê Moyen', '‚≠ê‚≠ê‚≠ê Difficile'],
                    datasets: [{
                        data: [difficultyCounts.facile, difficultyCounts.moyen, difficultyCounts.difficile],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.6)',
                            'rgba(255, 193, 7, 0.6)',
                            'rgba(220, 53, 69, 0.6)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
