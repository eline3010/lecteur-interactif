<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecteur Interactif - Analyse de Pr√©cision</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .text-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .text-to-read {
            font-size: 20px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 20px;
        }

        .text-to-read .word {
            display: inline;
            padding: 2px 4px;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .text-to-read .word.current {
            background: #fff3cd;
            font-weight: 600;
        }

        .text-to-read .word.correct {
            background: #d4edda;
        }

        .text-to-read .word.incorrect {
            background: #f8d7da;
        }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-btn.active {
            background: #667eea;
            color: white;
        }

        .difficulty-btn:hover {
            transform: translateY(-2px);
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            margin: 20px 0;
        }

        .recording-indicator.active {
            display: flex;
        }

        .pulse {
            width: 20px;
            height: 20px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .results-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .results-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 600;
            color: #555;
        }

        .metric-value {
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar {
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .history-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .history-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .chart-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .feedback {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .feedback-positive {
            border-left: 4px solid #28a745;
        }

        .feedback-warning {
            border-left: 4px solid #ffc107;
        }

        .tips {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .tips h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .tips ul {
            margin-left: 20px;
        }

        .tips li {
            margin-bottom: 5px;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .control-buttons {
                flex-direction: column;
            }
            
            .difficulty-selector {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Lecteur Interactif</h1>
            <p>Analyse de la pr√©cision en lecture - Identifie les mots difficiles</p>
        </div>

        <div class="content">
            <!-- Banni√®re d'avertissement pour les permissions -->
            <div id="permissionBanner" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none;">
                <h3 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è Permissions requises</h3>
                <p style="color: #856404; margin-bottom: 15px;">
                    Cette application a besoin d'acc√©der √† ton microphone pour fonctionner.
                </p>
                <p style="color: #856404; margin-bottom: 15px;">
                    <strong>Important :</strong> Quand tu cliques sur "Tester mon microphone" ou "Commencer la lecture", 
                    ton navigateur va afficher une petite fen√™tre en haut de la page te demandant d'autoriser l'acc√®s au microphone.
                </p>
                <p style="color: #856404; margin-bottom: 15px;">
                    üëâ <strong>Tu DOIS cliquer sur "Autoriser" ou "Allow"</strong> pour que l'application puisse t'√©couter lire.
                </p>
                <button onclick="document.getElementById('permissionBanner').style.display='none'" 
                        style="background: #ffc107; color: #333; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    J'ai compris
                </button>
            </div>

            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('lecture')">üìñ Lecture</button>
                <button class="tab-btn" onclick="switchTab('resultats')">üìä R√©sultats</button>
                <button class="tab-btn" onclick="switchTab('progres')">üìà Progr√®s</button>
            </div>

            <!-- Onglet Lecture -->
            <div id="lecture-tab" class="tab-content active">
                <div class="text-card">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Choisis le niveau de difficult√© :</h3>
                    <div class="difficulty-selector">
                        <button class="difficulty-btn active" onclick="selectDifficulty('facile')">‚≠ê Facile (CP-CE1)</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('moyen')">‚≠ê‚≠ê Moyen (CE2)</button>
                        <button class="difficulty-btn" onclick="selectDifficulty('difficile')">‚≠ê‚≠ê‚≠ê Difficile (CM1-CM2)</button>
                    </div>
                </div>

                <div class="text-card">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Texte √† lire :</h3>
                    <div class="text-to-read" id="textToRead"></div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üí° Avant de commencer :</h4>
                        <ul style="margin-left: 20px; color: #856404;">
                            <li>Assure-toi d'√™tre dans un endroit calme</li>
                            <li>Parle clairement et pas trop vite</li>
                            <li>Tiens-toi pr√®s du microphone</li>
                            <li>Autorise l'acc√®s au micro quand ton navigateur te le demande</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="testMicrophone()" style="margin-top: 10px; font-size: 14px; padding: 10px 15px;">
                            üé§ Tester mon microphone
                        </button>
                    </div>
                </div>

                <div class="recording-indicator" id="recordingIndicator">
                    <div class="pulse"></div>
                    <span style="font-weight: 600;">üé§ Enregistrement en cours... Lis le texte √† voix haute</span>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" id="startBtn" onclick="startReading()">
                        üé§ Commencer la lecture
                    </button>
                    <button class="btn btn-danger" id="stopBtn" onclick="stopReading()" disabled>
                        ‚èπÔ∏è Terminer
                    </button>
                    <button class="btn btn-secondary" onclick="loadNewText()">
                        üîÑ Nouveau texte
                    </button>
                </div>

                <div class="results-card" id="currentResults" style="display: none;">
                    <h3>üìä R√©sultats de cette lecture</h3>
                    <div id="sessionResults"></div>
                </div>
            </div>

            <!-- Onglet R√©sultats -->
            <div id="resultats-tab" class="tab-content">
                <div class="stats-grid" id="overallStats"></div>
                <div id="lastSessionDetails"></div>
            </div>

            <!-- Onglet Progr√®s -->
            <div id="progres-tab" class="tab-content">
                <div class="chart-container">
                    <h3>üìà √âvolution de la Pr√©cision</h3>
                    <canvas id="progressChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>üìä R√©partition des Niveaux de Difficult√©</h3>
                    <canvas id="difficultyChart"></canvas>
                </div>

                <div class="chart-container">
                    <h3>üìú Historique des S√©ances</h3>
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Textes de lecture par niveau
        const texts = {
            facile: [
                "Le chat est sur le tapis. Il dort au soleil. Il est tout doux.",
                "Papa lit un livre. Maman fait un g√¢teau. Je joue avec mon ballon.",
                "Dans le jardin, il y a des fleurs. Les fleurs sont jolies. J'aime les roses rouges.",
                "Mon ami s'appelle Tom. Il a un v√©lo bleu. Nous allons au parc ensemble.",
                "Le soleil brille dans le ciel. Les oiseaux chantent. C'est une belle journ√©e."
            ],
            moyen: [
                "L√©a adore les animaux. Chaque mercredi, elle va √† la ferme avec son grand-p√®re. Elle donne √† manger aux poules et aux lapins. C'est son moment pr√©f√©r√© de la semaine.",
                "Dans la for√™t, les arbres sont tr√®s hauts. Les √©cureuils sautent de branche en branche. Parfois, on peut voir des biches qui se prom√®nent tranquillement.",
                "Pierre collectionne les cailloux. Il a trouv√© un cristal brillant pr√®s de la rivi√®re. C'est son plus beau tr√©sor. Il le montre fi√®rement √† tous ses amis.",
                "La biblioth√®que du quartier est immense. Marie y va tous les samedis. Elle emprunte des livres d'aventures et de sciences. La biblioth√©caire est tr√®s gentille.",
                "Pendant les vacances, nous sommes all√©s √† la mer. J'ai construit un ch√¢teau de sable √©norme. Les vagues venaient doucement le mouiller. C'√©tait magnifique."
            ],
            difficile: [
                "L'exploration spatiale fascine les scientifiques depuis des d√©cennies. Les astronautes s'entra√Ænent pendant des ann√©es avant de partir en mission. Ils doivent apprendre √† vivre en apesanteur et √† r√©soudre des probl√®mes complexes dans des situations d'urgence.",
                "Les volcans sont des montagnes particuli√®res qui peuvent entrer en √©ruption. Le magma, cette roche en fusion venue des profondeurs de la Terre, remonte √† la surface. Quand il jaillit, on l'appelle de la lave. Les √©ruptions volcaniques peuvent √™tre spectaculaires mais aussi dangereuses.",
                "Au Moyen √Çge, les ch√¢teaux forts prot√©geaient les seigneurs et leurs familles. Ces imposantes forteresses √©taient entour√©es de douves remplies d'eau. Des pont-levis permettaient d'entrer et de sortir. Les soldats surveillaient les environs depuis les hautes tours.",
                "La photosynth√®se est un ph√©nom√®ne extraordinaire. Gr√¢ce √† la lumi√®re du soleil, les plantes transforment le dioxyde de carbone en oxyg√®ne. Ce processus est essentiel √† la vie sur Terre car il permet de purifier l'air que nous respirons.",
                "Les migrations des oiseaux restent myst√©rieuses. Chaque ann√©e, certaines esp√®ces parcourent des milliers de kilom√®tres. Elles traversent des oc√©ans et des continents pour retrouver des climats plus cl√©ments. Leur sens de l'orientation est remarquable."
            ]
        };

        let currentDifficulty = 'facile';
        let currentText = '';
        let currentWords = [];
        let recognition = null;
        let isRecording = false;
        let startTime = null;
        let sessionData = {
            wordsRead: 0,
            correctWords: 0,
            totalWords: 0,
            difficulty: '',
            transcript: ''
        };

        // Initialisation
        window.addEventListener('load', () => {
            loadNewText();
            loadHistory();
            updateStats();
            updateProgressCharts();
            
            // Afficher la banni√®re d'avertissement
            document.getElementById('permissionBanner').style.display = 'block';
            
            // V√©rifier la compatibilit√© de la reconnaissance vocale
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('‚ö†Ô∏è ATTENTION : Reconnaissance vocale non disponible\n\n' +
                      'Ton navigateur ne supporte pas la reconnaissance vocale.\n\n' +
                      'Pour utiliser cette application, tu dois utiliser :\n' +
                      '‚Ä¢ Chrome sur Android\n' +
                      '‚Ä¢ Safari sur iPhone/iPad\n' +
                      '‚Ä¢ Chrome ou Edge sur ordinateur\n\n' +
                      'Firefox ne supporte pas cette fonctionnalit√©.');
            }
            
            detectBrowserAndShowInstructions();
        });

        function detectBrowserAndShowInstructions() {
            const userAgent = navigator.userAgent.toLowerCase();
            let browserInfo = '';
            
            if (userAgent.includes('chrome') && !userAgent.includes('edge')) {
                browserInfo = '‚úÖ Navigateur d√©tect√© : Chrome\n\n' +
                              'Quand tu cliques sur "Tester mon microphone" :\n' +
                              '1. Une popup appara√Æt EN HAUT de la page\n' +
                              '2. Elle demande "Autoriser l\'acc√®s au microphone"\n' +
                              '3. Clique sur "Autoriser" ou "Allow"\n\n' +
                              'Si tu ne vois pas la popup :\n' +
                              '‚Ä¢ Regarde l\'ic√¥ne üé§ barr√©e dans la barre d\'adresse\n' +
                              '‚Ä¢ Clique dessus et active le microphone';
            } else if (userAgent.includes('safari') && !userAgent.includes('chrome')) {
                browserInfo = '‚úÖ Navigateur d√©tect√© : Safari\n\n' +
                              'Sur Safari, l\'autorisation appara√Æt en haut de l\'√©cran.\n' +
                              'Assure-toi d\'avoir autoris√© Safari √† acc√©der au micro dans les R√©glages de ton iPhone/iPad.';
            } else if (userAgent.includes('edge')) {
                browserInfo = '‚úÖ Navigateur d√©tect√© : Edge\n\n' +
                              'Une popup appara√Ætra en haut demandant l\'autorisation.\n' +
                              'Clique sur "Autoriser".';
            } else if (userAgent.includes('firefox')) {
                browserInfo = '‚ö†Ô∏è Firefox d√©tect√©\n\n' +
                              'ATTENTION : Firefox ne supporte pas bien la reconnaissance vocale en fran√ßais.\n\n' +
                              'Utilise plut√¥t Chrome ou Edge pour cette application.';
            }
            
            console.log(browserInfo);
        }

        // Fonction de test du microphone
        async function testMicrophone() {
            const userAgent = navigator.userAgent.toLowerCase();
            let instructionMsg = 'üé§ Test du microphone\n\n';
            
            if (userAgent.includes('chrome')) {
                instructionMsg += '1. Une popup va appara√Ætre EN HAUT de cette page\n';
                instructionMsg += '2. Cherche l\'ic√¥ne üé§ dans la barre d\'adresse\n';
                instructionMsg += '3. Clique sur "Autoriser" ou "Allow"\n\n';
                instructionMsg += '‚ö†Ô∏è Si tu ne vois rien :\n';
                instructionMsg += '‚Ä¢ Regarde tout en haut de la fen√™tre\n';
                instructionMsg += '‚Ä¢ Clique sur l\'ic√¥ne üé§ barr√©e √† c√¥t√© de l\'adresse';
            } else if (userAgent.includes('safari')) {
                instructionMsg += 'Une demande d\'autorisation va appara√Ætre.\n\n';
                instructionMsg += 'Si rien n\'appara√Æt :\n';
                instructionMsg += '‚Ä¢ Va dans R√©glages > Safari > Microphone\n';
                instructionMsg += '‚Ä¢ Autorise l\'acc√®s au microphone';
            } else {
                instructionMsg += 'Clique sur "Autoriser" quand la popup appara√Æt en haut.';
            }
            
            instructionMsg += '\n\nClique sur OK pour commencer le test.';
            
            alert(instructionMsg);
            
            try {
                console.log('Demande d\'acc√®s au microphone...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                console.log('‚úÖ Acc√®s au microphone obtenu');
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                let maxVolume = 0;
                const testDuration = 2000;
                const startTest = Date.now();
                
                const checkVolume = () => {
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                    if (average > maxVolume) maxVolume = average;
                    
                    if (Date.now() - startTest < testDuration) {
                        requestAnimationFrame(checkVolume);
                    } else {
                        stream.getTracks().forEach(track => track.stop());
                        audioContext.close();
                        
                        if (maxVolume > 10) {
                            alert('‚úÖ MICROPHONE FONCTIONNEL !\n\n' +
                                  '‚Ä¢ Niveau d√©tect√© : ' + Math.round(maxVolume) + '/255\n' +
                                  '‚Ä¢ Le microphone capte bien du son\n\n' +
                                  'Tu peux maintenant commencer la lecture.\n\n' +
                                  'üí° Conseils :\n' +
                                  '‚Ä¢ Parle clairement\n' +
                                  '‚Ä¢ Reste dans un endroit calme\n' +
                                  '‚Ä¢ Tiens-toi pr√®s du micro');
                        } else {
                            alert('‚ö†Ô∏è Microphone d√©tect√© mais tr√®s peu de son capt√©.\n\n' +
                                  'Niveau : ' + Math.round(maxVolume) + '/255\n\n' +
                                  'V√©rifie que :\n' +
                                  '‚Ä¢ Le micro n\'est pas en mode muet\n' +
                                  '‚Ä¢ Tu parles assez fort\n' +
                                  '‚Ä¢ Le bon micro est s√©lectionn√©\n\n' +
                                  'Essaie de dire "bonjour" et recommence le test.');
                        }
                    }
                };
                
                alert('üé§ Test en cours...\n\nDis "BONJOUR" ou "HELLO" maintenant !\n\nLe test dure 2 secondes.');
                
                checkVolume();
                
            } catch (error) {
                console.error('‚ùå Erreur de test micro:', error);
                
                let errorMessage = '‚ùå PROBL√àME D√âTECT√â :\n\n';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'üö´ Permission refus√©e\n\n';
                    errorMessage += 'Tu as bloqu√© l\'acc√®s au microphone.\n\n';
                    errorMessage += 'SOLUTION :\n';
                    
                    if (userAgent.includes('chrome')) {
                        errorMessage += '1. Clique sur l\'ic√¥ne üé§ ou üîí √† gauche de l\'adresse\n';
                        errorMessage += '2. Trouve "Microphone"\n';
                        errorMessage += '3. Change de "Bloquer" √† "Autoriser"\n';
                        errorMessage += '4. Recharge la page (F5)\n';
                        errorMessage += '5. Clique √† nouveau sur "Tester mon microphone"';
                    } else if (userAgent.includes('safari')) {
                        errorMessage += '1. Va dans Safari > R√©glages pour ce site web\n';
                        errorMessage += '2. Autorise le microphone\n';
                        errorMessage += '3. Recharge la page';
                    } else {
                        errorMessage += '1. Cherche l\'ic√¥ne de permission dans la barre d\'adresse\n';
                        errorMessage += '2. Autorise le microphone\n';
                        errorMessage += '3. Recharge la page';
                    }
                    
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'üé§ Aucun microphone d√©tect√©\n\n';
                    errorMessage += 'SOLUTIONS :\n';
                    errorMessage += '‚Ä¢ V√©rifie qu\'un micro est bien connect√©\n';
                    errorMessage += '‚Ä¢ Sur t√©l√©phone : v√©rifie que le micro n\'est pas bouch√©\n';
                    errorMessage += '‚Ä¢ Essaie avec des √©couteurs avec micro\n';
                    errorMessage += '‚Ä¢ Red√©marre ton appareil';
                    
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '‚ö†Ô∏è Microphone occup√©\n\n';
                    errorMessage += 'Une autre application utilise le micro.\n\n';
                    errorMessage += 'SOLUTIONS :\n';
                    errorMessage += '‚Ä¢ Ferme les autres apps (Zoom, Teams, etc.)\n';
                    errorMessage += '‚Ä¢ Ferme les autres onglets du navigateur\n';
                    errorMessage += '‚Ä¢ Red√©marre le navigateur';
                    
                } else {
                    errorMessage += 'Erreur : ' + error.name + '\n';
                    errorMessage += error.message + '\n\n';
                    errorMessage += 'Essaie de :\n';
                    errorMessage += '‚Ä¢ Recharger la page\n';
                    errorMessage += '‚Ä¢ Red√©marrer le navigateur\n';
                    errorMessage += '‚Ä¢ Utiliser Chrome ou Safari';
                }
                
                alert(errorMessage);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'progres') {
                updateProgressCharts();
            } else if (tabName === 'resultats') {
                updateStats();
            }
        }

        function selectDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadNewText();
        }

        function loadNewText() {
            const textArray = texts[currentDifficulty];
            currentText = textArray[Math.floor(Math.random() * textArray.length)];
            currentWords = currentText.split(' ');
            
            const textDiv = document.getElementById('textToRead');
            textDiv.innerHTML = currentWords.map((word, i) => 
                `<span class="word" id="word-${i}">${word}</span>`
            ).join(' ');

            document.getElementById('currentResults').style.display = 'none';
            sessionData = {
                wordsRead: 0,
                correctWords: 0,
                totalWords: currentWords.length,
                difficulty: currentDifficulty,
                transcript: ''
            };
        }

        async function startReading() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('‚ö†Ô∏è La reconnaissance vocale n\'est pas disponible sur ce navigateur.\n\nUtilisez Chrome, Edge ou Safari pour cette fonctionnalit√©.');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;

                startTime = Date.now();
                isRecording = true;

                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingIndicator').classList.add('active');

                let finalTranscript = '';

                recognition.onstart = () => {
                    console.log('üé§ Reconnaissance vocale d√©marr√©e');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                            console.log('Texte reconnu:', transcript);
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    sessionData.transcript = finalTranscript.trim();
                    analyzeReading(finalTranscript.toLowerCase());
                };

                recognition.onerror = (event) => {
                    console.error('Erreur de reconnaissance:', event.error);
                    
                    let errorMessage = '';
                    switch(event.error) {
                        case 'no-speech':
                            errorMessage = 'üé§ Aucune parole d√©tect√©e.\n\nAssure-toi de parler assez fort et que ton microphone fonctionne.';
                            break;
                        case 'audio-capture':
                            errorMessage = 'üé§ Impossible d\'acc√©der au microphone.\n\nV√©rifie que :\n- Le microphone est bien connect√©\n- Tu as autoris√© l\'acc√®s au micro\n- Aucune autre app n\'utilise le micro';
                            break;
                        case 'not-allowed':
                            errorMessage = 'üö´ Permission refus√©e.\n\nTu dois autoriser l\'acc√®s au microphone pour utiliser cette fonctionnalit√©.\n\nRecharge la page et clique sur "Autoriser" quand demand√©.';
                            isRecording = false;
                            document.getElementById('startBtn').disabled = false;
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('recordingIndicator').classList.remove('active');
                            break;
                        case 'network':
                            errorMessage = 'üåê Erreur r√©seau.\n\nLa reconnaissance vocale n√©cessite une connexion internet.';
                            break;
                        default:
                            errorMessage = `‚ö†Ô∏è Erreur: ${event.error}\n\nEssaie de recharger la page.`;
                    }
                    
                    if (errorMessage && event.error !== 'no-speech') {
                        alert(errorMessage);
                    }
                };

                recognition.onend = () => {
                    console.log('Reconnaissance termin√©e');
                    if (isRecording) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('Erreur lors du red√©marrage:', e);
                        }
                    }
                };

                recognition.start();
                
            } catch (error) {
                console.error('Erreur d\'acc√®s au microphone:', error);
                
                let errorMessage = 'üé§ Impossible d\'acc√©der au microphone.\n\n';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += 'Tu as refus√© l\'acc√®s au microphone.\n\nRecharge la page et clique sur "Autoriser" quand ton navigateur te le demande.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += 'Aucun microphone d√©tect√©.\n\nV√©rifie qu\'un microphone est bien connect√© √† ton appareil.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += 'Le microphone est peut-√™tre utilis√© par une autre application.\n\nFerme les autres apps qui utilisent le micro et r√©essaie.';
                } else {
                    errorMessage += 'Erreur: ' + error.message;
                }
                
                alert(errorMessage);
            }
        }

        function stopReading() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('recordingIndicator').classList.remove('active');

            calculateResults();
            saveSession();
            displayResults();
        }

        function analyzeReading(spokenText) {
            const spokenWords = spokenText.split(/\s+/).filter(w => w.length > 0);
            const textWords = currentWords.map(w => w.toLowerCase().replace(/[.,!?;:¬´¬ª'"]/g, ''));
            
            let matchCount = 0;
            
            const normalizedSpoken = spokenWords.map(w => w.replace(/[.,!?;:¬´¬ª'"]/g, ''));
            
            textWords.forEach((word, index) => {
                const wordElement = document.getElementById(`word-${index}`);
                
                const isMatched = normalizedSpoken.some(spoken => {
                    if (spoken === word) return true;
                    
                    if (spoken.includes(word) && word.length > 3) return true;
                    if (word.includes(spoken) && spoken.length > 3) return true;
                    
                    const maxDistance = word.length <= 4 ? 1 : Math.floor(word.length / 4);
                    if (levenshteinDistance(spoken, word) <= maxDistance) return true;
                    
                    if (word.length > 4 && spoken.length > 4) {
                        if (word.substring(0, 4) === spoken.substring(0, 4)) return true;
                    }
                    
                    return false;
                });
                
                if (isMatched) {
                    wordElement.classList.add('correct');
                    wordElement.classList.remove('incorrect');
                    matchCount++;
                } else if (normalizedSpoken.length > index) {
                    wordElement.classList.add('incorrect');
                    wordElement.classList.remove('correct');
                }
            });

            sessionData.wordsRead = spokenWords.length;
            sessionData.correctWords = matchCount;
            
            console.log(`Mots reconnus: ${matchCount}/${textWords.length} (${Math.round(matchCount/textWords.length*100)}%)`);
        }

        function levenshteinDistance(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[b.length][a.length];
        }

        function calculateResults() {
            sessionData.accuracy = sessionData.totalWords > 0 
                ? Math.round((sessionData.correctWords / sessionData.totalWords) * 100) 
                : 0;
            
            sessionData.date = new Date().toISOString();
        }

        function displayResults() {
            const resultsDiv = document.getElementById('sessionResults');
            const accuracy = sessionData.accuracy;
            
            let feedback = '';
            let feedbackClass = '';
            let tips = [];

            if (accuracy >= 90) {
                feedback = 'üéâ Excellent ! La plupart des mots ont √©t√© bien reconnus !';
                feedbackClass = 'feedback-positive';
                tips = [
                    'Excellente reconnaissance des mots',
                    'Tu peux essayer un niveau plus difficile',
                    'Continue √† lire r√©guli√®rement'
                ];
            } else if (accuracy >= 75) {
                feedback = 'üëç Tr√®s bon travail ! Bonne reconnaissance globale.';
                feedbackClass = 'feedback-positive';
                tips = [
                    'La majorit√© des mots ont √©t√© reconnus',
                    'Regarde les mots en rouge : ce sont ceux √† travailler',
                    'Essaye de bien articuler ces mots difficiles'
                ];
            } else if (accuracy >= 60) {
                feedback = 'üí™ Bon d√©but ! Certains mots posent encore des difficult√©s.';
                feedbackClass = 'feedback-warning';
                tips = [
                    'Les mots en rouge sont ceux qui n\'ont pas √©t√© bien capt√©s',
                    'Articule bien chaque syllabe',
                    'Relis le texte en te concentrant sur les mots difficiles',
                    'Note : le micro peut aussi avoir manqu√© certains mots'
                ];
            } else {
                feedback = 'üåü Continue ! Le micro a eu du mal √† capter beaucoup de mots.';
                feedbackClass = 'feedback-warning';
                tips = [
                    'V√©rifie que le microphone fonctionne bien',
                    'Parle plus fort et articule davantage',
                    '√âlimine les bruits de fond',
                    'Lis plus lentement en pronon√ßant bien',
                    'Un score faible peut venir du micro, pas forc√©ment de ta lecture !'
                ];
            }

            // Identifier les mots non reconnus
            const missedWords = [];
            currentWords.forEach((word, index) => {
                const wordElement = document.getElementById(`word-${index}`);
                if (wordElement && wordElement.classList.contains('incorrect')) {
                    missedWords.push(word);
                }
            });

            resultsDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Mots reconnus correctement :</span>
                    <span class="metric-value">${sessionData.correctWords} / ${sessionData.totalWords}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Taux de pr√©cision :</span>
                    <span class="metric-value">${accuracy}%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${accuracy}%">${accuracy}%</div>
                </div>
                
                ${missedWords.length > 0 ? `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üéØ Mots √† retravailler :</h4>
                    <p style="color: #856404; font-weight: 600;">${missedWords.join(', ')}</p>
                </div>
                ` : ''}
                
                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #0066cc;">
                    <p style="color: #0066cc; font-size: 14px; margin: 0;">
                        <strong>‚ÑπÔ∏è Important :</strong> La pr√©cision mesure quels mots ont √©t√© reconnus par le microphone. 
                        Les mots en <span style="background: #d4edda; padding: 2px 6px; border-radius: 3px;">vert</span> ont √©t√© bien capt√©s, 
                        ceux en <span style="background: #f8d7da; padding: 2px 6px; border-radius: 3px;">rouge</span> sont √† retravailler 
                        (ou n'ont pas √©t√© bien capt√©s par le micro).
                    </p>
                </div>
                
                <div class="feedback ${feedbackClass}" style="margin-top: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">${feedback}</h4>
                </div>
                
                <div class="tips">
                    <h4>üí° Observations :</h4>
                    <ul>
                        ${tips.map(tip => `<li>${tip}</li>`).join('')}
                    </ul>
                </div>
            `;

            document.getElementById('currentResults').style.display = 'block';
            updateStats();
        }

        function saveSession() {
            let history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            history.push(sessionData);
            localStorage.setItem('readingHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            const historyDiv = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>Aucune s√©ance enregistr√©e pour le moment.</p>
                        <p style="margin-top: 10px; color: #666;">Commence une lecture pour voir tes progr√®s ici !</p>
                    </div>
                `;
                return;
            }

            historyDiv.innerHTML = history.slice().reverse().map((session, index) => {
                const date = new Date(session.date);
                const difficultyLabel = {
                    'facile': '‚≠ê Facile',
                    'moyen': '‚≠ê‚≠ê Moyen',
                    'difficile': '‚≠ê‚≠ê‚≠ê Difficile'
                }[session.difficulty];

                return `
                    <div class="history-item">
                        <h4>${date.toLocaleDateString('fr-FR')} - ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</h4>
                        <p><strong>Niveau :</strong> ${difficultyLabel}</p>
                        <p><strong>Pr√©cision :</strong> ${session.accuracy}% (${session.correctWords}/${session.totalWords} mots reconnus)</p>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            if (history.length === 0) {
                document.getElementById('overallStats').innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üìä</div>
                        <p>Commence √† lire pour voir tes statistiques !</p>
                    </div>
                `;
                document.getElementById('lastSessionDetails').innerHTML = '';
                return;
            }

            const totalSessions = history.length;
            const avgAccuracy = Math.round(
                history.reduce((sum, s) => sum + s.accuracy, 0) / totalSessions
            );
            const lastSession = history[history.length - 1];

            document.getElementById('overallStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${totalSessions}</div>
                    <div class="stat-label">S√©ances</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${avgAccuracy}%</div>
                    <div class="stat-label">Pr√©cision moyenne</div>
                </div>
            `;

            const difficultyLabel = {
                'facile': '‚≠ê Facile',
                'moyen': '‚≠ê‚≠ê Moyen',
                'difficile': '‚≠ê‚≠ê‚≠ê Difficile'
            }[lastSession.difficulty];

            document.getElementById('lastSessionDetails').innerHTML = `
                <div class="results-card" style="margin-top: 20px;">
                    <h3>üìñ Derni√®re s√©ance</h3>
                    <div class="metric">
                        <span class="metric-label">Date :</span>
                        <span class="metric-value">${new Date(lastSession.date).toLocaleString('fr-FR')}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Niveau :</span>
                        <span class="metric-value">${difficultyLabel}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Pr√©cision :</span>
                        <span class="metric-value">${lastSession.accuracy}%</span>
                    </div>
                </div>
            `;
        }

        let progressChart = null;
        let difficultyChart = null;

        function updateProgressCharts() {
            const history = JSON.parse(localStorage.getItem('readingHistory') || '[]');
            
            if (history.length === 0) {
                return;
            }

            const ctx1 = document.getElementById('progressChart').getContext('2d');
            
            if (progressChart) progressChart.destroy();

            const dates = history.map(s => new Date(s.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'}));
            
            progressChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Pr√©cision (%)',
                            data: history.map(s => s.accuracy),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('difficultyChart').getContext('2d');
            
            if (difficultyChart) difficultyChart.destroy();

            const difficultyCounts = {
                facile: history.filter(s => s.difficulty === 'facile').length,
                moyen: history.filter(s => s.difficulty === 'moyen').length,
                difficile: history.filter(s => s.difficulty === 'difficile').length
            };

            difficultyChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['‚≠ê Facile', '‚≠ê‚≠ê Moyen', '‚≠ê‚≠ê‚≠ê Difficile'],
                    datasets: [{
                        data: [difficultyCounts.facile, difficultyCounts.moyen, difficultyCounts.difficile],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.6)',
                            'rgba(255, 193, 7, 0.6)',
                            'rgba(220, 53, 69, 0.6)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>